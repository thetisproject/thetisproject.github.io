<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>thetis.sediment_model &#8212; Thetis 0+untagged.2057.gbb0d01b.dirty documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/thetis.css?v=0f3339d6" />
    <script src="../../_static/documentation_options.js?v=05ff3d8c"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<!-- <link rel="stylesheet" href="../../_static/featured.css"> -->


<link rel="shortcut icon" href="../../_static/icon_thetis.ico" />


  </head><body>
<div class="wrapper">
  <a href="../../index.html"><img src="../../_static/banner.jpg" height="180px" alt="Thetis Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
        <li class="page_item"><a href="../../documentation.html" title="Thetis documentation">Documentation</a></li>
        <li class="page_item"><a href="../../download.html" title="Install Thetis">Download</a></li>
        <li class="page_item"><a href="../../team.html" title="Development team">Team</a></li>
        <li class="page_item"><a href="../../publications.html" title="Publications">Publications</a></li>
        <li class="page_item"><a href="../../funding.html" title="Our financial supporters">Funding</a></li>
        <li class="page_item"><a href="../../contact.html" title="Getting in touch">Contact</a></li>
        <li class="page_item"><a href="https://github.com/thetisproject/thetis" title="Thetis source on GitHub">GitHub</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
    <div class="_modules/thetis/sediment_model">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thetis.sediment_model</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">.utility</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">warning</span>


<div class="viewcode-block" id="CorrectiveVelocityFactor">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.CorrectiveVelocityFactor">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CorrectiveVelocityFactor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">ksp</span><span class="p">,</span> <span class="n">settling_velocity</span><span class="p">,</span> <span class="n">ustar</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up advective velocity factor `self.velocity_correction_factor`</span>
<span class="sd">        which accounts for mismatch between depth-averaged product of</span>
<span class="sd">        velocity with sediment and product of depth-averaged velocity</span>
<span class="sd">        with depth-averaged sediment.</span>

<span class="sd">        :arg depth: Depth of fluid</span>
<span class="sd">        :type depth: :class:`Function`</span>
<span class="sd">        :arg ksp: Grain roughness coefficient</span>
<span class="sd">        :type ksp: :class:`Constant`</span>
<span class="sd">        :arg settling_velocity: Settling velocity of the sediment particles</span>
<span class="sd">        :type settling_velocity: :class:`Constant`</span>
<span class="sd">        :arg ustar: Shear velocity</span>
<span class="sd">        :type ustar: :class:`Expression of functions`</span>
<span class="sd">        :arg a: Factor of bottom bed reference height</span>
<span class="sd">        :type a: :class:`Constant`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;von_karman&#39;</span><span class="p">]</span>

        <span class="c1"># correction factor to advection velocity in sediment concentration equation</span>
        <span class="n">Bconv</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span><span class="o">*</span><span class="n">ksp</span><span class="p">,</span> <span class="n">ksp</span><span class="o">/</span><span class="n">depth</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">1.1</span><span class="p">))</span>
        <span class="n">Aconv</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="n">depth</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="o">/</span><span class="n">depth</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mf">1.1</span><span class="p">))</span>

        <span class="c1"># take max of value calculated either by ksp or depth</span>
        <span class="n">Amax</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="n">Aconv</span> <span class="o">&gt;</span> <span class="n">Bconv</span><span class="p">,</span> <span class="n">Aconv</span><span class="p">,</span> <span class="n">Bconv</span><span class="p">)</span>

        <span class="n">r1conv</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">kappa</span><span class="p">)</span><span class="o">*</span><span class="n">conditional</span><span class="p">(</span><span class="n">settling_velocity</span><span class="o">/</span><span class="n">ustar</span> <span class="o">&lt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                                     <span class="n">settling_velocity</span><span class="o">/</span><span class="n">ustar</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="n">Ione</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="n">r1conv</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">),</span> <span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Amax</span><span class="o">**</span><span class="n">r1conv</span><span class="p">)</span><span class="o">/</span><span class="n">r1conv</span><span class="p">,</span>
                           <span class="n">conditional</span><span class="p">(</span><span class="n">r1conv</span> <span class="o">&lt;</span> <span class="n">Constant</span><span class="p">(</span><span class="o">-</span> <span class="mf">1e-8</span><span class="p">),</span> <span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">Amax</span><span class="o">**</span><span class="n">r1conv</span><span class="p">)</span><span class="o">/</span><span class="n">r1conv</span><span class="p">,</span> <span class="n">ln</span><span class="p">(</span><span class="n">Amax</span><span class="p">)))</span>

        <span class="n">Itwo</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="n">r1conv</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1e-8</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="n">Ione</span> <span class="o">+</span> <span class="p">(</span><span class="n">ln</span><span class="p">(</span><span class="n">Amax</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Amax</span><span class="o">**</span><span class="n">r1conv</span><span class="p">)))</span><span class="o">/</span><span class="n">r1conv</span><span class="p">,</span>
                           <span class="n">conditional</span><span class="p">(</span><span class="n">r1conv</span> <span class="o">&lt;</span> <span class="n">Constant</span><span class="p">(</span><span class="o">-</span> <span class="mf">1e-8</span><span class="p">),</span> <span class="o">-</span><span class="p">(</span><span class="n">Ione</span> <span class="o">+</span> <span class="p">(</span><span class="n">ln</span><span class="p">(</span><span class="n">Amax</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">Amax</span><span class="o">**</span><span class="n">r1conv</span><span class="p">)))</span><span class="o">/</span><span class="n">r1conv</span><span class="p">,</span>
                                       <span class="n">Constant</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">ln</span><span class="p">(</span><span class="n">Amax</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">Itwo</span> <span class="o">-</span> <span class="p">(</span><span class="n">ln</span><span class="p">(</span><span class="n">Amax</span><span class="p">)</span> <span class="o">-</span> <span class="n">ln</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span><span class="o">*</span><span class="n">Ione</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">Ione</span> <span class="o">*</span> <span class="p">((</span><span class="n">ln</span><span class="p">(</span><span class="n">Amax</span><span class="p">)</span> <span class="o">-</span> <span class="n">ln</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span> <span class="o">+</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># final correction factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity_correction_factor</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">depth</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;velocity correction factor&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity_correction_factor_expr</span> <span class="o">=</span> <span class="n">max_value</span><span class="p">(</span><span class="n">min_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)),</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>

<div class="viewcode-block" id="CorrectiveVelocityFactor.update">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.CorrectiveVelocityFactor.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Update `self.velocity_correction_factor` using the updated values for velocity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># final correction factor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity_correction_factor</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity_correction_factor_expr</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SedimentModel">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.SedimentModel">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SedimentModel</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">mesh2d</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">elev</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up a full morphological model simulation based on provided velocity and elevation functions.</span>

<span class="sd">        :arg options: Model options.</span>
<span class="sd">        :type options: :class:`.ModelOptions2d` instance</span>
<span class="sd">        :arg mesh2d: :class:`Mesh` object of the 2D mesh</span>
<span class="sd">        :arg uv: the velocity solution during the simulation</span>
<span class="sd">        :type uv: :class:`Function`</span>
<span class="sd">        :arg elev: the elevation solution during the simulation</span>
<span class="sd">        :type elev: :class:`Function`</span>
<span class="sd">        :arg depth: a :class:`DepthExpression` instance to evaluate the current depth</span>

<span class="sd">        The :class:`.SedimentModel` provides various expressions to be used in a suspended sediment and/or</span>
<span class="sd">        the Exner equation. NOTE that the functions used in these expressions need to be updated</span>
<span class="sd">        with the current values of the uv and elev fields by calling :func:`.SedimentModel.update`. This is not done</span>
<span class="sd">        in the initialisation of the sediment model, so that the :class:`.SedimentModel` can be created before</span>
<span class="sd">        initial conditions have been assigned to uv and elev. After the initial conditions have been</span>
<span class="sd">        assigned a call to update is required to ensure that the initial values are reflected in</span>
<span class="sd">        the :class:`.SedimentModel` terms.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uv</span> <span class="o">=</span> <span class="n">uv</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">elev</span> <span class="o">=</span> <span class="n">elev</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">depth</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_suspended_sediment</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">solve_suspended_sediment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_bedload</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">use_bedload</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_sediment_slide</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">use_sediment_slide</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_angle_correction</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">use_angle_correction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_slope_mag_correction</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">use_slope_mag_correction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_advective_velocity_correction</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">use_advective_velocity_correction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_secondary_current</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">use_secondary_current</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span> <span class="o">=</span> <span class="n">mesh2d</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bedload</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_angle_correction</span><span class="p">:</span>
                <span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Slope effect angle correction only applies to bedload transport which is not used in this simulation&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_slope_mag_correction</span><span class="p">:</span>
                <span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Slope effect magnitude correction only applies to bedload transport which is not used in this simulation&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_secondary_current</span><span class="p">:</span>
                <span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Secondary current only applies to bedload transport which is not used in this simulation&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">average_size</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">average_sediment_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bed_reference_height</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">bed_reference_height</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhos</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">sediment_density</span>

        <span class="c1"># define function spaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1DG_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s2">&quot;DG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R_1d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s2">&quot;R&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">P1v_2d</span> <span class="o">=</span> <span class="n">VectorFunctionSpace</span><span class="p">(</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s2">&quot;CG&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n</span> <span class="o">=</span> <span class="n">FacetNormal</span><span class="p">(</span><span class="n">mesh2d</span><span class="p">)</span>

        <span class="c1"># define parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;g_grav&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhow</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;rho0&#39;</span><span class="p">]</span>
        <span class="n">kappa</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;von_karman&#39;</span><span class="p">]</span>

        <span class="n">ksp</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_reference_height</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">morphological_viscosity</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">horizontal_viscosity</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">morphological_viscosity</span>

        <span class="c1"># magnitude slope effect parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">slope_effect_parameter</span>
        <span class="c1"># angle correction slope effect parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surbeta2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">slope_effect_angle_parameter</span>
        <span class="c1"># secondary current parameter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_secc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">secondary_current_parameter</span>

        <span class="c1"># calculate critical shields parameter thetacr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">R</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhos</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span> <span class="o">-</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dstar</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="nb">float</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[:]))</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;dstar value less than 1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">thetacr</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mf">0.24</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)),</span>
                                                        <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.14</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.64</span><span class="p">)),</span>
                                                        <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">,</span> <span class="mf">0.04</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.1</span><span class="p">)),</span>
                                                                    <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span> <span class="o">&lt;</span> <span class="mi">150</span><span class="p">,</span> <span class="mf">0.013</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span><span class="o">**</span><span class="p">(</span><span class="mf">0.29</span><span class="p">)),</span> <span class="mf">0.055</span><span class="p">)))))</span>

        <span class="c1"># critical bed shear stress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">taucr</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rhos</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">thetacr</span><span class="p">)</span>

        <span class="c1"># calculate settling velocity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settling_velocity</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span> <span class="o">&lt;=</span> <span class="mf">1e-04</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">/</span><span class="p">(</span><span class="mi">18</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span><span class="p">),</span>
                                                                              <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span> <span class="o">&lt;=</span> <span class="mf">1e-03</span><span class="p">,</span> <span class="p">(</span><span class="mi">10</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="p">)</span>
                                                                                          <span class="o">*</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.01</span><span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">**</span><span class="mi">3</span><span class="p">))</span>
                                                                                             <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viscosity</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span><span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="mf">1.1</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="p">))))</span>

        <span class="c1"># first step: project velocity to CG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv_cg</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1v_2d</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">old_bathymetry_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">get_total_depth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_cg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_cg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># define bed friction</span>
        <span class="n">hc</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.001</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.001</span><span class="p">))</span>
        <span class="n">aux</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="mf">11.036</span><span class="o">*</span><span class="n">hc</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_reference_height</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.001</span><span class="p">),</span>
                          <span class="mf">11.036</span><span class="o">*</span><span class="n">hc</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_reference_height</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.001</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qfc</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ln</span><span class="p">(</span><span class="n">aux</span><span class="p">)</span><span class="o">/</span><span class="n">kappa</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="c1"># skin friction coefficient</span>
        <span class="n">cfactor</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span> <span class="o">&gt;</span> <span class="n">ksp</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
                              <span class="o">*</span> <span class="p">(((</span><span class="mi">1</span><span class="o">/</span><span class="n">kappa</span><span class="p">)</span><span class="o">*</span><span class="n">ln</span><span class="p">(</span><span class="mf">11.036</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="o">/</span><span class="n">ksp</span><span class="p">))</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">)),</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="c1"># mu - ratio between skin friction and normal friction</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">cfactor</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># calculate bed shear stress</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unorm</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bed_stress</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">*</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_suspended_sediment</span><span class="p">:</span>
            <span class="c1"># deposition flux - calculating coefficient to account for stronger conc at bed</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="p">)</span>
            <span class="n">ustar</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rouse_number</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">settling_velocity</span><span class="o">/</span><span class="p">(</span><span class="n">kappa</span><span class="o">*</span><span class="n">ustar</span><span class="p">))</span> <span class="o">-</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">intermediate_step</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rouse_number</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1e-04</span><span class="p">),</span>
                                                 <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">*</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">**</span><span class="n">min_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rouse_number</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">3</span><span class="p">)))</span><span class="o">/</span><span class="n">min_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rouse_number</span><span class="p">,</span>
                                                 <span class="n">Constant</span><span class="p">(</span><span class="mi">3</span><span class="p">)),</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="o">*</span><span class="n">ln</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">integrated_rouse</span> <span class="o">=</span> <span class="n">max_value</span><span class="p">(</span><span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_step</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1e-12</span><span class="p">),</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">intermediate_step</span><span class="p">,</span>
                                                          <span class="n">Constant</span><span class="p">(</span><span class="mf">1e12</span><span class="p">)),</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

            <span class="c1"># erosion flux - above critical velocity bed is eroded</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transport_stage_param</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">*</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
                                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">*</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">taucr</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">taucr</span><span class="p">,</span>
                                                     <span class="n">Constant</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">erosion_concentration</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1DG_2d</span><span class="p">)</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.015</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
                                                                        <span class="o">*</span> <span class="p">((</span><span class="n">max_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport_stage_param</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span>
                                                                        <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span><span class="o">**</span><span class="mf">0.3</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_advective_velocity_correction</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">correction_factor_model</span> <span class="o">=</span> <span class="n">CorrectiveVelocityFactor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="p">,</span> <span class="n">ksp</span><span class="p">,</span>
                                                                        <span class="bp">self</span><span class="o">.</span><span class="n">settling_velocity</span><span class="p">,</span> <span class="n">ustar</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">velocity_correction_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">correction_factor_model</span><span class="o">.</span><span class="n">velocity_correction_factor</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equilibrium_tracer</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1DG_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">erosion_concentration</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">integrated_rouse</span><span class="p">)</span>

            <span class="c1"># get individual terms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deposition</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settling_velocity</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">integrated_rouse</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_erosion</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settling_velocity</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">erosion_concentration</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bedload</span><span class="p">:</span>
            <span class="c1"># calculate angle of flow</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calfa</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_cg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">salfa</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_cg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_angle_correction</span><span class="p">:</span>
                <span class="c1"># slope effect angle correction due to gravity</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stress</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1DG_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">*</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">)</span>

<div class="viewcode-block" id="SedimentModel.get_bedload_term">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.SedimentModel.get_bedload_term">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_bedload_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bathymetry</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns expression for bedload transport :math:`(qbx, qby)` to be used in the Exner equation.</span>
<span class="sd">        Note bathymetry is the function which is solved for in the exner equation.</span>

<span class="sd">        :arg bathymetry: Bathymetry of the domain. Bathymetry stands for</span>
<span class="sd">            the bedlevel (positive downwards).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># define bed gradient</span>
        <span class="n">dzdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_bathymetry_2d</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">dzdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">old_bathymetry_2d</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_slope_mag_correction</span><span class="p">:</span>
            <span class="c1"># slope effect magnitude correction due to gravity where beta is a parameter normally set to 1.3</span>
            <span class="c1"># we use z_n1 and equals so that we can use an implicit method in Exner</span>
            <span class="n">slopecoef</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="o">*</span><span class="p">(</span><span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">calfa</span> <span class="o">+</span> <span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">salfa</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">slopecoef</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_angle_correction</span><span class="p">:</span>
            <span class="c1"># slope effect angle correction due to gravity</span>
            <span class="n">cparam</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span><span class="o">.</span><span class="n">interpolate</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rhos</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surbeta2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">tt1</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stress</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">cparam</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">cparam</span><span class="o">/</span><span class="n">Constant</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">)))</span>

            <span class="c1"># add on a factor of the bed gradient to the normal</span>
            <span class="n">aa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">salfa</span> <span class="o">+</span> <span class="n">tt1</span><span class="o">*</span><span class="n">dzdy</span>
            <span class="n">bb</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calfa</span> <span class="o">+</span> <span class="n">tt1</span><span class="o">*</span><span class="n">dzdx</span>

            <span class="n">comb</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="n">aa</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">bb</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">angle_norm</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="n">comb</span> <span class="o">&gt;</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">),</span> <span class="n">comb</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mf">1e-10</span><span class="p">))</span>

            <span class="c1"># we use z_n1 and equals so that we can use an implicit method in Exner</span>
            <span class="n">calfamod</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calfa</span> <span class="o">+</span> <span class="p">(</span><span class="n">tt1</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="o">/</span><span class="n">angle_norm</span>
            <span class="n">salfamod</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">salfa</span> <span class="o">+</span> <span class="p">(</span><span class="n">tt1</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)))</span><span class="o">/</span><span class="n">angle_norm</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_secondary_current</span><span class="p">:</span>
            <span class="c1"># accounts for helical flow effect in a curver channel</span>
            <span class="c1"># use z_n1 and equals so can use an implicit method in Exner</span>
            <span class="n">free_surface_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">free_surface_dy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">velocity_slide</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">free_surface_dy</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">*</span><span class="n">free_surface_dx</span><span class="p">)</span>

            <span class="n">tandelta_factor</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span>\
                <span class="o">/</span> <span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">alpha_secc</span><span class="o">*</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>

            <span class="c1"># accounts for helical flow effect in a curver channel</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_angle_correction</span><span class="p">:</span>
                <span class="c1"># if angle has already been corrected we must alter the corrected angle to obtain the corrected secondary current angle</span>
                <span class="n">t_1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_stress</span><span class="o">*</span><span class="n">slopecoef</span><span class="o">*</span><span class="n">calfamod</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">*</span><span class="n">tandelta_factor</span><span class="o">*</span><span class="n">velocity_slide</span><span class="p">)</span>
                <span class="n">t_2</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_stress</span><span class="o">*</span><span class="n">slopecoef</span><span class="o">*</span><span class="n">salfamod</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">tandelta_factor</span><span class="o">*</span><span class="n">velocity_slide</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_1</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_stress</span><span class="o">*</span><span class="n">slopecoef</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">calfa</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">v</span><span class="o">*</span><span class="n">tandelta_factor</span><span class="o">*</span><span class="n">velocity_slide</span><span class="p">)</span>
                <span class="n">t_2</span> <span class="o">=</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_stress</span><span class="o">*</span><span class="n">slopecoef</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">salfa</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">u</span><span class="o">*</span><span class="n">tandelta_factor</span><span class="o">*</span><span class="n">velocity_slide</span><span class="p">))</span>

            <span class="c1"># calculated to normalise the new angles</span>
            <span class="n">t4</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">((</span><span class="n">t_1</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">t_2</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

            <span class="c1"># updated magnitude correction and angle corrections</span>
            <span class="n">slopecoef_secc</span> <span class="o">=</span> <span class="n">t4</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">bed_stress</span>

            <span class="n">calfanew</span> <span class="o">=</span> <span class="n">t_1</span><span class="o">/</span><span class="n">t4</span>
            <span class="n">salfanew</span> <span class="o">=</span> <span class="n">t_2</span><span class="o">/</span><span class="n">t4</span>

        <span class="c1"># implement meyer-peter-muller bedload transport formula</span>
        <span class="n">thetaprime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">*</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">)</span><span class="o">/</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">rhos</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="p">)</span>

        <span class="c1"># if velocity above a certain critical value then transport occurs</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="n">thetaprime</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">thetacr</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">thetaprime</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">thetacr</span><span class="p">)</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span>

        <span class="c1"># bedload transport flux with magnitude correction</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_secondary_current</span><span class="p">:</span>
            <span class="n">qb_total</span> <span class="o">=</span> <span class="n">slopecoef_secc</span><span class="o">*</span><span class="n">phi</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qb_total</span> <span class="o">=</span> <span class="n">slopecoef</span><span class="o">*</span><span class="n">phi</span><span class="o">*</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">g</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">R</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">**</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># formulate bedload transport flux with correct angle depending on corrections implemented</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_angle_correction</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_secondary_current</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">qbx</span> <span class="o">=</span> <span class="n">qb_total</span><span class="o">*</span><span class="n">calfamod</span>
            <span class="n">qby</span> <span class="o">=</span> <span class="n">qb_total</span><span class="o">*</span><span class="n">salfamod</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_secondary_current</span><span class="p">:</span>
            <span class="n">qbx</span> <span class="o">=</span> <span class="n">qb_total</span><span class="o">*</span><span class="n">calfanew</span>
            <span class="n">qby</span> <span class="o">=</span> <span class="n">qb_total</span><span class="o">*</span><span class="n">salfanew</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qbx</span> <span class="o">=</span> <span class="n">qb_total</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">calfa</span>
            <span class="n">qby</span> <span class="o">=</span> <span class="n">qb_total</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">salfa</span>

        <span class="k">return</span> <span class="n">qbx</span><span class="p">,</span> <span class="n">qby</span></div>


<div class="viewcode-block" id="SedimentModel.get_sediment_slide_term">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.SedimentModel.get_sediment_slide_term">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_sediment_slide_term</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bathymetry</span><span class="p">):</span>
        <span class="c1"># add component to bedload transport to ensure the slope angle does not exceed a certain value</span>

        <span class="c1"># maximum gradient allowed by sediment slide mechanism</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tanphi</span> <span class="o">=</span> <span class="n">tan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">max_angle</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="mi">180</span><span class="p">)</span>
        <span class="c1"># approximate mesh step size for sediment slide mechanism</span>
        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">sed_slide_length_scale</span>

        <span class="n">degree_h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">P1_2d</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">degree_h</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="mf">1.5</span> <span class="o">/</span> <span class="n">CellSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="mf">5.0</span><span class="o">*</span><span class="n">degree_h</span><span class="o">*</span><span class="p">(</span><span class="n">degree_h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">CellSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">)</span>

        <span class="c1"># define bed gradient</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">SpatialCoordinate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">slide_region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dzdx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">slide_region</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dzdy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">slide_region</span><span class="o">*</span><span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dzdx</span> <span class="o">=</span> <span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">dzdy</span> <span class="o">=</span> <span class="n">bathymetry</span><span class="o">.</span><span class="n">dx</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># calculate normal to the bed</span>
        <span class="n">nz</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">dzdx</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">dzdy</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">betaangle</span> <span class="o">=</span> <span class="n">asin</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">nz</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tanbeta</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">nz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">/</span><span class="n">nz</span>

        <span class="n">morfac</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">morphological_acceleration_factor</span>

        <span class="c1"># calculating magnitude of added component</span>
        <span class="n">qaval</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tanbeta</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanphi</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">porosity</span><span class="p">)</span>
                            <span class="o">*</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">L</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tanbeta</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tanphi</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">betaangle</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep</span>
                                                                           <span class="o">*</span> <span class="n">morfac</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="c1"># multiplying by direction</span>
        <span class="n">alphaconst</span> <span class="o">=</span> <span class="n">conditional</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">nz</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="n">qaval</span><span class="o">*</span><span class="p">(</span><span class="n">nz</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">nz</span><span class="o">**</span><span class="mi">2</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>

        <span class="n">diff_tensor</span> <span class="o">=</span> <span class="n">as_matrix</span><span class="p">([[</span><span class="n">alphaconst</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">alphaconst</span><span class="p">,</span> <span class="p">]])</span>

        <span class="k">return</span> <span class="n">diff_tensor</span></div>


<div class="viewcode-block" id="SedimentModel.get_deposition_coefficient">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.SedimentModel.get_deposition_coefficient">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_deposition_coefficient</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns coefficient :math:`C` such that :math:`C/H*sediment` is deposition term in sediment equation</span>

<span class="sd">        If sediment field is depth-averaged, :math:`C*sediment` is (total) deposition (over the column)</span>
<span class="sd">        as it appears in the Exner equation, but deposition term in sediment equation needs</span>
<span class="sd">        averaging: :math:`C*sediment/H`</span>
<span class="sd">        If sediment field is depth-integrated, :math:`C*sediment/H` is (total) deposition (over the column)</span>
<span class="sd">        as it appears in the Exner equation, and is the same in the sediment equation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deposition</span></div>


<div class="viewcode-block" id="SedimentModel.get_erosion_term">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.SedimentModel.get_erosion_term">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_erosion_term</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns expression for (depth-integrated) erosion.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_erosion</span></div>


<div class="viewcode-block" id="SedimentModel.get_equilibrium_tracer">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.SedimentModel.get_equilibrium_tracer">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_equilibrium_tracer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns expression for (depth-averaged) equilibrium tracer.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">equilibrium_tracer</span></div>


<div class="viewcode-block" id="SedimentModel.get_advective_velocity_correction_factor">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.SedimentModel.get_advective_velocity_correction_factor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_advective_velocity_correction_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns correction factor for the advective velocity in the sediment equations</span>

<span class="sd">        With :attr:`.SedimentModelOptions.use_advective_velocity_correction`, this applies a correction to</span>
<span class="sd">        the supplied velocity solution `uv` to take into account the mismatch between</span>
<span class="sd">        depth-averaged product of velocity with sediment and product of depth-averaged</span>
<span class="sd">        velocity with depth-averaged sediment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_advective_velocity_correction</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_correction_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="SedimentModel.update">
<a class="viewcode-back" href="../../thetis.html#thetis.sediment_model.SedimentModel.update">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Update all functions used by :class:`.SedimentModel`</span>

<span class="sd">        This repeats all projection and interpolations steps based on the current values</span>
<span class="sd">        of the `uv` and `elev` functions, provided in __init__.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">uv_cg</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">old_bathymetry_2d</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_tot</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">get_total_depth</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">elev</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bed_stress</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">*</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_suspended_sediment</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">erosion_concentration</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.015</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">average_size</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
                                               <span class="o">*</span> <span class="p">((</span><span class="n">max_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transport_stage_param</span><span class="p">,</span> <span class="n">Constant</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span><span class="o">**</span><span class="mf">1.5</span><span class="p">)</span>
                                               <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dstar</span><span class="o">**</span><span class="mf">0.3</span><span class="p">))</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">equilibrium_tracer</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">erosion_concentration</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">integrated_rouse</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_bedload</span><span class="p">:</span>
            <span class="c1"># calculate angle of flow</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">calfa</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_cg</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">salfa</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_cg</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">))</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_angle_correction</span><span class="p">:</span>
                <span class="c1"># slope effect angle correction due to gravity</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stress</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rhow</span><span class="o">*</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">qfc</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">unorm</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_advective_velocity_correction</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correction_factor_model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
    </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2016-2025, Tuomas Krn et al..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>