
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>thetis.timeintegrator &#8212; Thetis 0+untagged.1888.gc4e776a documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thetis.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<!-- <link rel="stylesheet" href="../../_static/featured.css"> -->


<link rel="shortcut icon" href="../../_static/icon_thetis.ico" />


  </head><body>
<div class="wrapper">
  <a href="../../index.html"><img src="../../_static/banner.jpg" height="180px" alt="Thetis Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
        <li class="page_item"><a href="../../documentation.html" title="Thetis documentation">Documentation</a></li>
        <li class="page_item"><a href="../../download.html" title="Install Thetis">Download</a></li>
        <li class="page_item"><a href="../../team.html" title="Development team">Team</a></li>
        <li class="page_item"><a href="../../publications.html" title="Publications">Publications</a></li>
        <li class="page_item"><a href="../../funding.html" title="Our financial supporters">Funding</a></li>
        <li class="page_item"><a href="../../contact.html" title="Getting in touch">Contact</a></li>
        <li class="page_item"><a href="https://github.com/thetisproject/thetis" title="Thetis source on GitHub">GitHub</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
    <div class="_modules/thetis/timeintegrator">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thetis.timeintegrator</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Generic time integration schemes to advance equations in time.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">.utility</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">ABCMeta</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span> <span class="nn">numpy</span>

<span class="n">CFL_UNCONDITIONALLY_STABLE</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">inf</span>
<span class="c1"># CFL coefficient for unconditionally stable methods</span>


<div class="viewcode-block" id="TimeIntegratorBase"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.TimeIntegratorBase">[docs]</a><span class="k">class</span> <span class="nc">TimeIntegratorBase</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class that defines the API for all time integrators</span>

<span class="sd">    Both :class:`TimeIntegrator` and :class:`CoupledTimeIntegrator` inherit</span>
<span class="sd">    from this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__metaclass__</span> <span class="o">=</span> <span class="n">ABCMeta</span>

<div class="viewcode-block" id="TimeIntegratorBase.advance"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.TimeIntegratorBase.advance">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Advances equations for one time step</span>

<span class="sd">        :arg t: simulation time</span>
<span class="sd">        :type t: float</span>
<span class="sd">        :arg update_forcings: user-defined function that takes the simulation</span>
<span class="sd">            time and updates any time-dependent boundary conditions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>

<div class="viewcode-block" id="TimeIntegratorBase.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.TimeIntegratorBase.initialize">[docs]</a>    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize the time integrator</span>

<span class="sd">        :arg init_solution: initial solution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div></div>


<div class="viewcode-block" id="TimeIntegrator"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.TimeIntegrator">[docs]</a><span class="k">class</span> <span class="nc">TimeIntegrator</span><span class="p">(</span><span class="n">TimeIntegratorBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Base class for all time integrator objects that march a single equation</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: the equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">equation</span> <span class="o">=</span> <span class="n">equation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">=</span> <span class="n">solution</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>  <span class="c1"># FIXME this might not be correctly updated ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span>

        <span class="c1"># unique identifier for solver</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;-&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">ad_block_tag</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">solver_parameters</span>

<div class="viewcode-block" id="TimeIntegrator.set_dt"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.TimeIntegrator.set_dt">[docs]</a>    <span class="k">def</span> <span class="nf">set_dt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Update time step&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span></div>

<div class="viewcode-block" id="TimeIntegrator.advance_picard"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.TimeIntegrator.advance_picard">[docs]</a>    <span class="k">def</span> <span class="nf">advance_picard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_lagged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Advances equations for one time step within a Picard iteration</span>

<span class="sd">        :arg t: simulation time</span>
<span class="sd">        :type t: float</span>
<span class="sd">        :arg update_forcings: user-defined function that takes the simulation</span>
<span class="sd">            time and updates any time-dependent boundary conditions</span>
<span class="sd">        :kwarg update_lagged: should the old solution be updated?</span>
<span class="sd">        :kwarg update_fields: should the fields be updated?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Picard iterations are not supported for </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2"> time integrators.&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="ForwardEuler"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ForwardEuler">[docs]</a><span class="k">class</span> <span class="nc">ForwardEuler</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Standard forward Euler time integration scheme.&quot;&quot;&quot;</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ForwardEuler.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: the equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForwardEuler</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">)</span>

        <span class="c1"># create functions to hold the values of previous time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">Function</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">Constant</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">u_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span>
        <span class="n">u_tri</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">trial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u_tri</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">L</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u_old</span><span class="p">)</span>
                  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
                  <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="ForwardEuler.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ForwardEuler.update_solver">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ForwardEuler.update_solver&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">A</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">L</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                              <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                              <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="ForwardEuler.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ForwardEuler.initialize">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ForwardEuler.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="c1"># assign values to old functions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>

<div class="viewcode-block" id="ForwardEuler.advance"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ForwardEuler.advance">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ForwardEuler.advance&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># shift time</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="CrankNicolson"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.CrankNicolson">[docs]</a><span class="k">class</span> <span class="nc">CrankNicolson</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Standard Crank-Nicolson time integration scheme.&quot;&quot;&quot;</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span>

    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.CrankNicolson.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: the equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CrankNicolson</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">implicitness_theta</span>
        <span class="n">semi_implicit</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">use_semi_implicit_linearization</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;solution_old&#39;</span><span class="p">)</span>
        <span class="c1"># create functions to hold the values of previous time step</span>
        <span class="c1"># TODO is this necessary? is self.fields sufficient?</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">Function</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">()</span><span class="o">+</span><span class="s1">&#39;_old&#39;</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">Constant</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span>
        <span class="n">u_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="c1"># linearize around last timestep using the fact that all terms are</span>
            <span class="c1"># written in the form A(u_nl) u</span>
            <span class="n">u_nl</span> <span class="o">=</span> <span class="n">u_old</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solve the full nonlinear residual form</span>
            <span class="n">u_nl</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">bnd</span> <span class="o">=</span> <span class="n">bnd_conditions</span>
        <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
        <span class="n">f_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span>

        <span class="c1"># Crank-Nicolson</span>
        <span class="n">theta_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u_old</span><span class="p">)</span>
                  <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="p">(</span><span class="n">theta_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_nl</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">bnd</span><span class="p">)</span>
                                   <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta_const</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">u_old</span><span class="p">,</span> <span class="n">f_old</span><span class="p">,</span> <span class="n">f_old</span><span class="p">,</span> <span class="n">bnd</span><span class="p">))</span>
                  <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="CrankNicolson.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.CrankNicolson.update_solver">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.CrankNicolson.update_solver&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create solver objects&quot;&quot;&quot;</span>
        <span class="c1"># Ensure LU assembles monolithic matrices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pc_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;lu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;mat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aij&#39;</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                                 <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                 <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="CrankNicolson.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.CrankNicolson.initialize">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.CrankNicolson.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="c1"># assign values to old functions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>

<div class="viewcode-block" id="CrankNicolson.advance"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.CrankNicolson.advance">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.CrankNicolson.advance&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="c1"># shift time</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>

<div class="viewcode-block" id="CrankNicolson.advance_picard"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.CrankNicolson.advance_picard">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.CrankNicolson.advance_picard&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">advance_picard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_lagged</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">update_fields</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step in a Picard iteration.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">update_lagged</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">update_fields</span><span class="p">:</span>
            <span class="c1"># shift time</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="SteadyState"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SteadyState">[docs]</a><span class="k">class</span> <span class="nc">SteadyState</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Time integrator that solves the steady state equations, leaving out the</span>
<span class="sd">    mass terms</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span>

    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SteadyState.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: the equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SteadyState</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="SteadyState.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SteadyState.update_solver">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SteadyState.update_solver&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create solver objects&quot;&quot;&quot;</span>
        <span class="c1"># Ensure LU assembles monolithic matrices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pc_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;lu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;mat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aij&#39;</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                                 <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                 <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="SteadyState.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SteadyState.initialize">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SteadyState.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="c1"># nothing to do here as the initial condition is passed in via solution</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="SteadyState.advance"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SteadyState.advance">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SteadyState.advance&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="PressureProjectionPicard"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.PressureProjectionPicard">[docs]</a><span class="k">class</span> <span class="nc">PressureProjectionPicard</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Pressure projection scheme with Picard iteration for shallow water</span>
<span class="sd">    equations</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># FIXME what is the right value?</span>

    <span class="c1"># TODO add more documentation</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.PressureProjectionPicard.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">equation_mom</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: free surface equation</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg equation_mom: momentum equation</span>
<span class="sd">        :type equation_mom: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PressureProjectionPicard</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">theta</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">implicitness_theta</span>
        <span class="n">semi_implicit</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">use_semi_implicit_linearization</span>
        <span class="n">solver_parameters</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">solver_parameters_pressure</span>
        <span class="n">solver_parameters_mom</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">solver_parameters_momentum</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">picard_iterations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">equation_mom</span> <span class="o">=</span> <span class="n">equation_mom</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters_mom</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">solver_parameters_mom</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters_mom</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">solver_parameters_mom</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="c1"># solve a preliminary linearized momentum equation before</span>
            <span class="c1"># solving the linearized wave equation terms in a coupled system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters_mom</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not sure this combination makes much sense: keep both systems nonlinear</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters_mom</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="n">iterations</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iterations</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_lagged</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_lagged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span>
        <span class="n">uv_lagged</span><span class="p">,</span> <span class="n">eta_lagged</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_lagged</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="n">uv_old</span><span class="p">,</span> <span class="n">eta_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;ksp_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;preonly&#39;</span>
                <span class="ow">and</span> <span class="s1">&#39;fieldsplit_H_2d&#39;</span> <span class="ow">in</span> <span class="n">solver_parameters</span>
                <span class="ow">and</span> <span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;fieldsplit_H_2d&#39;</span><span class="p">][</span><span class="s1">&#39;ksp_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;preonly&#39;</span>
                <span class="ow">and</span> <span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;fieldsplit_H_2d&#39;</span><span class="p">][</span><span class="s1">&#39;pc_python_type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;thetis.AssembledSchurPC&#39;</span>
                <span class="ow">and</span> <span class="n">element_continuity</span><span class="p">(</span><span class="n">eta_old</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">())</span><span class="o">.</span><span class="n">horizontal</span> <span class="o">!=</span> <span class="s1">&#39;cg&#39;</span><span class="p">):</span>
            <span class="c1"># the default settings use AssembledSchurPC which assumes that the velocity block is only a dg mass matrix</span>
            <span class="c1"># Under these assumptions this preconditioner assembles the exact Schur complement. If this is not true, we either need</span>
            <span class="c1"># iterations with the unassembled Schur complement (fieldsplit_H_2d_ksp_type), or alternatively iterations outside</span>
            <span class="c1"># the fieldsplit to deal with the fact that we haven&#39;t solved the Schur complement exactly.</span>
            <span class="c1"># Currently only the dg-cg element pair, gives a pure DG  mass matrix velocity block: for dg-dg the pressure gradient adds a</span>
            <span class="c1"># Riemann term in the velocity block, for rt-dg the velocity block cannot be explicitly inverted either.</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;The timestepper PressureProjectionPicard is only recommended in combination with the &quot;</span>
                            <span class="s2">&quot;dg-cg element_family. If you want to use it in combination with dg-dg or rt-dg you need to adjust the solver_parameters_pressure option.&quot;</span><span class="p">)</span>

        <span class="c1"># create functions to hold the values of previous time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">Function</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">Constant</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
        <span class="c1"># for the mom. eqn. the &#39;eta&#39; field is just one of the &#39;other&#39; fields</span>
        <span class="n">fields_mom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fields_mom_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">fields_mom</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eta_lagged</span>
        <span class="n">fields_mom_old</span><span class="p">[</span><span class="s1">&#39;eta&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">eta_old</span>

        <span class="c1"># the velocity solved for in the preliminary mom. solve:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv_star</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation_mom</span><span class="o">.</span><span class="n">function_space</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="n">uv_star_nl</span> <span class="o">=</span> <span class="n">uv_lagged</span>
            <span class="n">solution_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_lagged</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">uv_star_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_star</span>
            <span class="n">solution_nl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span>

        <span class="c1"># form for mom. eqn.:</span>
        <span class="n">theta_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F_mom</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equation_mom</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_star</span><span class="p">)</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">equation_mom</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">uv_old</span><span class="p">)</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="p">(</span>
                <span class="n">theta_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation_mom</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_star</span><span class="p">,</span> <span class="n">uv_star_nl</span><span class="p">,</span> <span class="n">fields_mom</span><span class="p">,</span> <span class="n">fields_mom</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta_const</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation_mom</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">uv_old</span><span class="p">,</span> <span class="n">uv_old</span><span class="p">,</span> <span class="n">fields_mom_old</span><span class="p">,</span> <span class="n">fields_mom_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># form for wave eqn. system:</span>
        <span class="c1"># M (u^n+1 - u^*) + G (eta^n+theta - eta_lagged) = 0</span>
        <span class="c1"># M (eta^n+1 - eta^n) + C (u^n+theta) = 0</span>
        <span class="c1"># the &#39;implicit&#39; terms are the gradient (G) and divergence term (C) in the mom. and continuity eqn. resp.</span>
        <span class="c1"># where u^* is the velocity solved for in the mom. eqn., and G eta_lagged the gradient term in that eqn.</span>
        <span class="n">uv_test</span><span class="p">,</span> <span class="n">eta_test</span> <span class="o">=</span> <span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">test</span><span class="p">)</span>
        <span class="n">mass_term_star</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">uv_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_star</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> <span class="o">+</span> <span class="n">inner</span><span class="p">(</span><span class="n">eta_test</span><span class="p">,</span> <span class="n">eta_old</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span> <span class="o">-</span> <span class="n">mass_term_star</span>
            <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="p">(</span>
                <span class="n">theta_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="n">solution_nl</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
                <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta_const</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;implicit&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># subtract G eta_lagged: G is the implicit term in the mom. eqn.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation_mom</span><span class="o">.</span><span class="n">terms</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation_mom</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;implicit&#39;</span><span class="p">:</span>
                <span class="n">term</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">terms</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">+=</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="p">(</span>
                    <span class="o">-</span> <span class="n">theta_const</span><span class="o">*</span><span class="n">term</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uv_star</span><span class="p">,</span> <span class="n">eta_lagged</span><span class="p">,</span> <span class="n">uv_star_nl</span><span class="p">,</span> <span class="n">eta_lagged</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
                    <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">theta_const</span><span class="p">)</span><span class="o">*</span><span class="n">term</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">uv_old</span><span class="p">,</span> <span class="n">eta_old</span><span class="p">,</span> <span class="n">uv_old</span><span class="p">,</span> <span class="n">eta_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
                <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="PressureProjectionPicard.update_solver"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.PressureProjectionPicard.update_solver">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.PressureProjectionPicard.update_solver&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create solver objects&quot;&quot;&quot;</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F_mom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uv_star</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver_mom</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span>
                                                     <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters_mom</span><span class="p">,</span>
                                                     <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="o">+</span><span class="s1">&#39;_mom&#39;</span><span class="p">,</span>
                                                     <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span> <span class="o">+</span> <span class="s1">&#39;_mom&#39;</span><span class="p">)</span>
        <span class="c1"># Ensure LU assembles monolithic matrices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pc_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;lu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;mat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aij&#39;</span>
        <span class="n">prob</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span>
                                                 <span class="n">appctx</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="n">derivative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)},</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                                 <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                 <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span><span class="p">)</span></div>

<div class="viewcode-block" id="PressureProjectionPicard.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.PressureProjectionPicard.initialize">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.PressureProjectionPicard.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_lagged</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="c1"># assign values to old functions</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div>

<div class="viewcode-block" id="PressureProjectionPicard.advance"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.PressureProjectionPicard.advance">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.PressureProjectionPicard.advance&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solution_lagged</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">timed_stage</span><span class="p">(</span><span class="s2">&quot;Momentum solve&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solver_mom</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
            <span class="k">with</span> <span class="n">timed_stage</span><span class="p">(</span><span class="s2">&quot;Pressure solve&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

        <span class="c1"># shift time</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields_old</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">k</span><span class="p">])</span></div></div>


<div class="viewcode-block" id="LeapFrogAM3"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.LeapFrogAM3">[docs]</a><span class="k">class</span> <span class="nc">LeapFrogAM3</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Leap-Frog Adams-Moulton 3 ALE time integrator</span>

<span class="sd">    Defined in (2.27)-(2.30) in [1]; (2.21)-(2.22) in [2]</span>

<span class="sd">    [1] Shchepetkin and McWilliams (2005). The regional oceanic modeling system</span>
<span class="sd">    (ROMS): a split-explicit, free-surface, topography-following-coordinate</span>
<span class="sd">    oceanic model. Ocean Modelling, 9(4):347-404.</span>
<span class="sd">    http://dx.doi.org/10.1016/j.ocemod.2013.04.010</span>

<span class="sd">    [2] Shchepetkin and McWilliams (2009). Computational Kernel Algorithms for</span>
<span class="sd">    Fine-Scale, Multiprocess, Longtime Oceanic Simulations, 14:121-183.</span>
<span class="sd">    http://dx.doi.org/10.1016/S1570-8659(08)01202-0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.5874</span>

    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.LeapFrogAM3.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">,</span> <span class="n">terms_to_add</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        :kwarg terms_to_add: Defines which terms of the equation are to be</span>
<span class="sd">            added to this solver. Default &#39;all&#39; implies [&#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;].</span>
<span class="sd">        :type terms_to_add: &#39;all&#39; or list of &#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">LeapFrogAM3</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="mf">12.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gamma_const</span> <span class="o">=</span> <span class="n">Constant</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span><span class="p">)</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;old solution&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msolution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dual solution&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rhs_func</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;rhs linear form&#39;</span><span class="p">)</span>

        <span class="c1"># fully explicit evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">terms_to_add</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                                      <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_new</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_old</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="n">a</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>
        <span class="n">c</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">gamma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_prediction</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_old</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_new</span> <span class="o">+</span> <span class="n">c</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span>

<div class="viewcode-block" id="LeapFrogAM3.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.LeapFrogAM3.initialize">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.LeapFrogAM3.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrix</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msolution_old</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_solver</span> <span class="o">=</span> <span class="n">LinearSolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_matrix</span><span class="p">)</span></div>
        <span class="c1"># TODO: Linear solver is not annotated and does not accept ad_block_tag</span>

    <span class="k">def</span> <span class="nf">_solve_system</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves system mass_matrix*solution = rhs_func</span>

<span class="sd">        If the function space is fully discontinuous, the mass matrix is</span>
<span class="sd">        inverted in place for efficiency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_func</span><span class="p">)</span>

<div class="viewcode-block" id="LeapFrogAM3.predict"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.LeapFrogAM3.predict">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.LeapFrogAM3.predice&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">predict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prediction step from :math:`t_{n-1/2}` to :math:`t_{n+1/2}`</span>

<span class="sd">        Let :math:`M_n` denote the mass matrix at time :math:`t_{n}`.</span>
<span class="sd">        The prediction step is</span>

<span class="sd">        .. math::</span>
<span class="sd">            T_{n-1/2} &amp;= (1/2 - 2\gamma) T_{n-1} + (1/2 + 2 \gamma) T_{n} \\</span>
<span class="sd">            M_n T_{n+1/2} &amp;= M_n T_{n-1/2} + \Delta t (1 - 2\gamma) M_n L_{n}</span>

<span class="sd">        This is computed in a fixed mesh: all terms are evaluated in</span>
<span class="sd">        :math:`\Omega_n`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;lf_pre_asmb_sol&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mass_new</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">msolution_old</span><span class="p">)</span>  <span class="c1"># store current solution</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;lf_pre_asmb_rhs&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l_prediction</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_func</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;lf_pre_asgn_sol&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>  <span class="c1"># time shift</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;lf_pre_solve&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_system</span><span class="p">()</span></div>

<div class="viewcode-block" id="LeapFrogAM3.eval_rhs"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.LeapFrogAM3.eval_rhs">[docs]</a>    <span class="k">def</span> <span class="nf">eval_rhs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;lf_cor_asmb_rhs&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rhs_func</span><span class="p">)</span></div>

<div class="viewcode-block" id="LeapFrogAM3.correct"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.LeapFrogAM3.correct">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.LeapFrogAM3.correct&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">correct</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Correction step from :math:`t_{n}` to :math:`t_{n+1}`</span>

<span class="sd">        Let :math:`M_n` denote the mass matrix at time :math:`t_{n}`.</span>
<span class="sd">        The correction step is</span>

<span class="sd">        .. math::</span>
<span class="sd">            M_{n+1} T_{n+1} = M_{n} T_{n} + \Delta t L_{n+1/2}</span>

<span class="sd">        This is Euler ALE step: LHS is evaluated in :math:`\Omega_{n+1}`,</span>
<span class="sd">        RHS in :math:`\Omega_n`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="c1"># NOTE must call eval_rhs in the old mesh first</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;lf_cor_incr_rhs&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rhs_func</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">msolution_old</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;lf_cor_asmb_mat&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mass_matrix</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;lf_cor_solve&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_solve_system</span><span class="p">()</span></div>

<div class="viewcode-block" id="LeapFrogAM3.advance"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.LeapFrogAM3.advance">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.LeapFrogAM3.advance&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">predict</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">eval_rhs</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">correct</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="SSPRK22ALE"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE">[docs]</a><span class="k">class</span> <span class="nc">SSPRK22ALE</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
    <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    SSPRK(2,2) ALE time integrator for 3D fields</span>

<span class="sd">    The scheme is</span>

<span class="sd">    .. math::</span>
<span class="sd">        u^{(1)} &amp;= u^{n} + \Delta t F(u^{n}) \\</span>
<span class="sd">        u^{n+1} &amp;= u^{n} + \frac{\Delta t}{2}(F(u^{n}) +  F(u^{(1)}))</span>

<span class="sd">    Both stages are implemented as ALE updates from geometry :math:`\Omega_n`</span>
<span class="sd">    to :math:`\Omega_{(1)}`, and :math:`\Omega_{n+1}`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">,</span> <span class="n">terms_to_add</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        :kwarg terms_to_add: Defines which terms of the equation are to be</span>
<span class="sd">            added to this solver. Default &#39;all&#39; implies [&#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;].</span>
<span class="sd">        :type terms_to_add: &#39;all&#39; or list of &#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">SSPRK22ALE</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dual solution&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;dual solution&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tendency&#39;</span><span class="p">)</span>

        <span class="c1"># fully explicit evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">terms_to_add</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                                      <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                                      <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mu_form</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

<div class="viewcode-block" id="SSPRK22ALE.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE.initialize">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>

        <span class="n">mass_matrix</span> <span class="o">=</span> <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lin_solver</span> <span class="o">=</span> <span class="n">LinearSolver</span><span class="p">(</span><span class="n">mass_matrix</span><span class="p">,</span>
                                       <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="c1"># TODO: Linear solver is not annotated and does not accept ad_block_tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="SSPRK22ALE.stage_one_prep"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE.stage_one_prep">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.stage_one_prep&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">stage_one_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess first stage: compute all forms on the old geometry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="c1"># Compute $Mu$ and assign $q_{old} = Mu$</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;pre1_asseble_mu&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_form</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu_old</span><span class="p">)</span>
            <span class="c1"># Evaluate $k = \Delta t F(u)$</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;pre1_asseble_f&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="p">)</span>
            <span class="c1"># $q = q_{old} + k$</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;pre1_incr_rhs&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_old</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK22ALE.stage_one_solve"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE.stage_one_solve">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.stage_one_solve&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">stage_one_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        First stage: solve :math:`u^{(1)}` given previous solution :math:`u^n`.</span>

<span class="sd">        This is a forward Euler ALE step between domains :math:`\Omega^n` and :math:`\Omega^{(1)}`:</span>

<span class="sd">        .. math::</span>

<span class="sd">            \int_{\Omega^{(1)}} u^{(1)} \psi dx = \int_{\Omega^n} u^n \psi dx + \Delta t \int_{\Omega^n} F(u^n) \psi dx</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="c1"># Solve $u = M^{-1}q$</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;sol1_assemble_A&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_solver</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;sol1_solve&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lin_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK22ALE.stage_two_prep"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE.stage_two_prep">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.stage_two_prep&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">stage_two_prep</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess 2nd stage: compute all forms on the old geometry</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="c1"># Evaluate $k = \Delta t F(u)$</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;pre2_asseble_f&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="p">)</span>
            <span class="c1"># $q = \frac{1}{2}q + \frac{1}{2}q_{old} + \frac{1}{2}k$</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;pre2_incr_rhs&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mu</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">mu_old</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK22ALE.stage_two_solve"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE.stage_two_solve">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.stage_two_solve&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">stage_two_solve</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        2nd stage: solve :math:`u^{n+1}` given previous solutions :math:`u^n, u^{(1)}`.</span>

<span class="sd">        This is an ALE step:</span>

<span class="sd">        .. math::</span>

<span class="sd">            \int_{\Omega^{n+1}} u^{n+1} \psi dx &amp;= \int_{\Omega^n} u^n \psi dx \\</span>
<span class="sd">                &amp;+ \frac{\Delta t}{2} \int_{\Omega^n} F(u^n) \psi dx \\</span>
<span class="sd">                &amp;+ \frac{\Delta t}{2} \int_{\Omega^{(1)}} F(u^{(1)}) \psi dx</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="c1"># Solve $u = M^{-1}q$</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;sol2_assemble_A&#39;</span><span class="p">):</span>
                <span class="n">assemble</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lin_solver</span><span class="o">.</span><span class="n">A</span><span class="p">)</span>
            <span class="k">with</span> <span class="n">timed_region</span><span class="p">(</span><span class="s1">&#39;sol2_solve&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lin_solver</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mu</span><span class="p">)</span></div>

<div class="viewcode-block" id="SSPRK22ALE.solve_stage"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE.solve_stage">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.solve_stage&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Solves i-th stage&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage_one_solve</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage_two_solve</span><span class="p">()</span></div>

<div class="viewcode-block" id="SSPRK22ALE.prepare_stage"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE.prepare_stage">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.prepare_stage&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">prepare_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Preprocess stage i_stage.</span>

<span class="sd">        This must be called prior to updating mesh geometry.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage_one_prep</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage_two_prep</span><span class="p">()</span></div>

<div class="viewcode-block" id="SSPRK22ALE.advance"><a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK22ALE.advance">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.SSPRK22ALE.advance&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i_stage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prepare_stage</span><span class="p">(</span><span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">i_stage</span><span class="p">)</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
    </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2022, Tuomas Krn et al..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>