<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>thetis.solver2d &#8212; Thetis 0+untagged.2082.gf1a0bbb documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/thetis.css?v=0f3339d6" />
    <script src="../../_static/documentation_options.js?v=ccd1159c"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<!-- <link rel="stylesheet" href="../../_static/featured.css"> -->


<link rel="shortcut icon" href="../../_static/icon_thetis.ico" />


  </head><body>
<div class="wrapper">
  <a href="../../index.html"><img src="../../_static/banner.jpg" height="180px" alt="Thetis Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
        <li class="page_item"><a href="../../documentation.html" title="Thetis documentation">Documentation</a></li>
        <li class="page_item"><a href="../../download.html" title="Install Thetis">Download</a></li>
        <li class="page_item"><a href="../../team.html" title="Development team">Team</a></li>
        <li class="page_item"><a href="../../publications.html" title="Publications">Publications</a></li>
        <li class="page_item"><a href="../../funding.html" title="Our financial supporters">Funding</a></li>
        <li class="page_item"><a href="../../contact.html" title="Getting in touch">Contact</a></li>
        <li class="page_item"><a href="https://github.com/thetisproject/thetis" title="Thetis source on GitHub">GitHub</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
    <div class="_modules/thetis/solver2d">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thetis.solver2d</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for 2D depth averaged solver</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utility</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">shallowwater_eq</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">timeintegrator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">rungekutta</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">implicitexplicit</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">coupled_timeintegrator_2d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">tracer_eq_2d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">sediment_eq_2d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">exner_eq</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">weakref</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">time_mod</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">mpi4py</span><span class="w"> </span><span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">exporter</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.turbines</span><span class="w"> </span><span class="kn">import</span> <span class="n">TidalTurbineFarm</span><span class="p">,</span> <span class="n">DiscreteTidalTurbineFarm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.field_defs</span><span class="w"> </span><span class="kn">import</span> <span class="n">field_metadata</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.options</span><span class="w"> </span><span class="kn">import</span> <span class="n">ModelOptions2d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.</span><span class="w"> </span><span class="kn">import</span> <span class="n">callback</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.log</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">thetis.limiter</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">limiter</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>


<div class="viewcode-block" id="FlowSolver2d">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">FlowSolver2d</span><span class="p">(</span><span class="n">FrozenClass</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main object for 2D depth averaged solver</span>

<span class="sd">    **Example**</span>

<span class="sd">    Create mesh</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from thetis import *</span>
<span class="sd">        mesh2d = RectangleMesh(20, 20, 10e3, 10e3)</span>

<span class="sd">    Create bathymetry function, set a constant value</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        fs_p1 = FunctionSpace(mesh2d, &#39;CG&#39;, 1)</span>
<span class="sd">        bathymetry_2d = Function(fs_p1, name=&#39;Bathymetry&#39;).assign(10.0)</span>

<span class="sd">    Create solver object and set some options</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        solver_obj = solver2d.FlowSolver2d(mesh2d, bathymetry_2d)</span>
<span class="sd">        options = solver_obj.options</span>
<span class="sd">        options.element_family = &#39;dg-dg&#39;</span>
<span class="sd">        options.polynomial_degree = 1</span>
<span class="sd">        options.swe_timestepper_type = &#39;CrankNicolson&#39;</span>
<span class="sd">        options.simulation_export_time = 50.0</span>
<span class="sd">        options.simulation_end_time = 3600.</span>
<span class="sd">        options.timestep = 25.0</span>

<span class="sd">    Assign initial condition for water elevation</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        solver_obj.create_function_spaces()</span>
<span class="sd">        init_elev = Function(solver_obj.function_spaces.H_2d)</span>
<span class="sd">        coords = SpatialCoordinate(mesh2d)</span>
<span class="sd">        init_elev.project(exp(-((coords[0] - 4e3)**2 + (coords[1] - 4.5e3)**2)/2.2e3**2))</span>
<span class="sd">        solver_obj.assign_initial_conditions(elev=init_elev)</span>

<span class="sd">    Run simulation</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        solver_obj.iterate()</span>

<span class="sd">    See the manual for more complex examples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh2d</span><span class="p">,</span> <span class="n">bathymetry_2d</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_log</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg mesh2d: :class:`Mesh` object of the 2D mesh</span>
<span class="sd">        :arg bathymetry_2d: Bathymetry of the domain. Bathymetry stands for</span>
<span class="sd">            the mean water depth (positive downwards).</span>
<span class="sd">        :type bathymetry_2d: :class:`Function`</span>
<span class="sd">        :kwarg options: Model options (optional). Model options can also be</span>
<span class="sd">            changed directly via the :attr:`.options` class property.</span>
<span class="sd">        :type options: :class:`.ModelOptions2d` instance</span>
<span class="sd">        :kwarg bool keep_log: append to an existing log file, or overwrite it?</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span> <span class="o">=</span> <span class="n">mesh2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">mesh2d</span><span class="o">.</span><span class="n">comm</span>

        <span class="c1"># add boundary length info</span>
        <span class="n">bnd_len</span> <span class="o">=</span> <span class="n">compute_boundary_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">boundary_len</span> <span class="o">=</span> <span class="n">bnd_len</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Time step&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">ModelOptions2d</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of all options. A :class:`.ModelOptions2d` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># simulation time step bookkeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">CallbackManager</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`.CallbackManager` object that stores all callbacks</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">FieldDict</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`.FieldDict` that holds all functions needed by the solver</span>
<span class="sd">        object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">()</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`.AttrDict` that holds all function spaces needed by the</span>
<span class="sd">        solver object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span> <span class="o">=</span> <span class="n">bathymetry_2d</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">export_initial_state</span> <span class="o">=</span> <span class="kc">True</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Do export initial state. False if continuing a simulation&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sediment_model</span> <span class="o">=</span> <span class="kc">None</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;set up option for sediment model&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shallow_water&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;tracer&#39;</span><span class="p">:</span> <span class="p">{},</span> <span class="s1">&#39;sediment&#39;</span><span class="p">:</span> <span class="p">{}}</span>

        <span class="k">if</span> <span class="s1">&#39;tracer_2d&#39;</span> <span class="ow">in</span> <span class="n">field_metadata</span><span class="p">:</span>
            <span class="n">field_metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tracer_2d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_tracer</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keep_log</span> <span class="o">=</span> <span class="n">keep_log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_preproc_funcs</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="FlowSolver2d.compute_time_step">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.compute_time_step">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.compute_time_step&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_scale</span><span class="o">=</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes maximum explicit time step from CFL condition.</span>

<span class="sd">        .. math :: \Delta t = \frac{\Delta x}{U}</span>

<span class="sd">        Assumes velocity scale :math:`U = \sqrt{g H} + U_{scale}` where</span>
<span class="sd">        :math:`U_{scale}` is estimated advective velocity.</span>

<span class="sd">        :kwarg u_scale: User provided maximum advective velocity scale</span>
<span class="sd">        :type u_scale: float or :class:`Constant`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span>
        <span class="n">bath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">bath</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span>
        <span class="n">bath_pos</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bathymetry&#39;</span><span class="p">)</span>
        <span class="n">bath_pos</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">bath</span><span class="p">)</span>
        <span class="n">min_depth</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">bath_pos</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">bath_pos</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">min_depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_depth</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">trial</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;g_grav&#39;</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">bath_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">u_scale</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">csize</span> <span class="o">/</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="n">solve</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">l</span><span class="p">,</span> <span class="n">solution</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">solution</span></div>


<div class="viewcode-block" id="FlowSolver2d.compute_mesh_stats">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.compute_mesh_stats">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.compute_mesh_stats&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_mesh_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes number of elements, nodes etc and prints to sdtout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nnodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">P1DG_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG_2d</span>
        <span class="n">nelem2d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P1DG_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="o">/</span><span class="n">P1DG_2d</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">())</span>
        <span class="n">dofs_elev2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">dofs_u2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">dofs_tracer2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">Q_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">dofs_elev2d_core</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dofs_elev2d</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">dofs_tracer2d_core</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dofs_tracer2d</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">min_h_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
        <span class="n">max_h_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">MPI</span><span class="o">.</span><span class="n">MAX</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_only</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Element family: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span><span class="si">}</span><span class="s1">, degree: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_tracer</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tracer element family: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_element_family</span><span class="si">}</span><span class="s1">, degree: 1&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;2D cell type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;2D mesh: </span><span class="si">{</span><span class="n">nnodes</span><span class="si">}</span><span class="s1"> vertices, </span><span class="si">{</span><span class="n">nelem2d</span><span class="si">}</span><span class="s1"> elements&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Horizontal element size: </span><span class="si">{</span><span class="n">min_h_size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> ... </span><span class="si">{</span><span class="n">max_h_size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> m&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_only</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of 2D elevation DOFs: </span><span class="si">{</span><span class="n">dofs_elev2d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of 2D velocity DOFs: </span><span class="si">{</span><span class="n">dofs_u2d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_tracer</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of 2D tracer DOFs: </span><span class="si">{</span><span class="n">dofs_tracer2d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of cores: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_only</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Elevation DOFs per core: ~</span><span class="si">{</span><span class="n">dofs_elev2d_core</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_tracer</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tracer DOFs per core: ~</span><span class="si">{</span><span class="n">dofs_tracer2d_core</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowSolver2d.set_time_step">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.set_time_step">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.set_time_step&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the model the model time step</span>

<span class="sd">        If the time integrator supports automatic time step, and</span>
<span class="sd">        :attr:`ModelOptions2d.timestepper_options.use_automatic_timestep` is</span>
<span class="sd">        `True`, we compute the maximum time step allowed by the CFL condition.</span>
<span class="sd">        Otherwise uses :attr:`ModelOptions2d.timestep`.</span>

<span class="sd">        :kwarg float alpha: CFL number scaling factor</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">automatic_timestep</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">sed_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span>
        <span class="n">ts_options</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">swe_timestepper_options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_timestepper_options</span><span class="p">,</span>
            <span class="n">sed_options</span><span class="o">.</span><span class="n">sediment_timestepper_options</span><span class="p">,</span> <span class="n">sed_options</span><span class="o">.</span><span class="n">exner_timestepper_options</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">free_surface_timestepper_options</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">ts_options</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;use_automatic_timestep&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">options</span><span class="o">.</span><span class="n">use_automatic_timestep</span><span class="p">:</span>
                <span class="n">automatic_timestep</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># TODO revisit math alpha is OBSOLETE</span>
        <span class="k">if</span> <span class="n">automatic_timestep</span><span class="p">:</span>
            <span class="n">mesh2d_dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_time_step</span><span class="p">(</span><span class="n">u_scale</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">horizontal_velocity_scale</span><span class="p">)</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">cfl_2d</span><span class="o">*</span><span class="n">alpha</span><span class="o">*</span><span class="nb">float</span><span class="p">(</span><span class="n">mesh2d_dt</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">dt</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">rank</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;dt = </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="FlowSolver2d.set_wetting_and_drying_alpha">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.set_wetting_and_drying_alpha">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.set_wetting_and_drying_alpha&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">set_wetting_and_drying_alpha</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compute a wetting and drying parameter :math:`\alpha` which ensures positive water</span>
<span class="sd">        depth using the approximate method suggested by Karna et al. (2011).</span>

<span class="sd">        This method takes</span>

<span class="sd">      ..math::</span>
<span class="sd">            \alpha \approx \mid L_x \nabla h \mid,</span>

<span class="sd">        where :math:`L_x` is the horizontal length scale of the mesh elements at the wet-dry</span>
<span class="sd">        front and :math:`h` is the bathymetry profile.</span>

<span class="sd">        This expression is interpolated into :math:`\mathbb P1` space in order to remove noise. Note</span>
<span class="sd">        that we use the `interpolate` method, rather than the `project` method, in order to avoid</span>
<span class="sd">        introducing new extrema.</span>

<span class="sd">        NOTE: The minimum and maximum values at which to cap the alpha parameter may be specified via</span>
<span class="sd">        :attr:`ModelOptions2d.wetting_and_drying_alpha_min` and</span>
<span class="sd">        :attr:`ModelOptions2d.wetting_and_drying_alpha_max`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_wetting_and_drying</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_automatic_wetting_and_drying_alpha</span><span class="p">:</span>
            <span class="n">min_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wetting_and_drying_alpha_min</span>
            <span class="n">max_alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wetting_and_drying_alpha_max</span>

            <span class="c1"># Take the dot product and threshold it</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">dot</span><span class="p">(</span><span class="n">get_cell_widths_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">),</span> <span class="nb">abs</span><span class="p">(</span><span class="n">grad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">max_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">min_value</span><span class="p">(</span><span class="n">max_alpha</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">min_alpha</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">alpha</span> <span class="o">=</span> <span class="n">max_value</span><span class="p">(</span><span class="n">min_alpha</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>

            <span class="c1"># Interpolate into P1 space</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wetting_and_drying_alpha</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wetting_and_drying_alpha</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>

        <span class="c1"># Print to screen and check validity</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wetting_and_drying_alpha</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Using constant wetting and drying parameter (value </span><span class="si">{:.2f}</span><span class="s2">)&quot;</span>
            <span class="k">assert</span> <span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mf">0.0</span>
            <span class="n">print_output</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="n">values</span><span class="p">()[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Using spatially varying wetting and drying parameter (min </span><span class="si">{:.2f}</span><span class="s2"> max </span><span class="si">{:.2f}</span><span class="s2">)&quot;</span>
            <span class="k">with</span> <span class="n">alpha</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">vec_ro</span> <span class="k">as</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">alpha_min</span><span class="p">,</span> <span class="n">alpha_max</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">min</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span> <span class="n">v</span><span class="o">.</span><span class="n">max</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">assert</span> <span class="n">alpha_min</span> <span class="o">&gt;=</span> <span class="mf">0.0</span>
                <span class="n">print_output</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha_min</span><span class="p">,</span> <span class="n">alpha_max</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Wetting and drying parameter of type &#39;</span><span class="si">{:}</span><span class="s2">&#39; not supported&quot;</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">alpha</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span></div>


<div class="viewcode-block" id="FlowSolver2d.create_function_spaces">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.create_function_spaces">[docs]</a>
    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.create_function_spaces&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_function_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates function spaces</span>

<span class="sd">        Function spaces are accessible via :attr:`.function_spaces`</span>
<span class="sd">        object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">on_the_sphere</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">geometric_dimension</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">on_the_sphere</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rt-dg&#39;</span><span class="p">,</span> <span class="s1">&#39;bdm-dg&#39;</span><span class="p">],</span> \
                <span class="s1">&#39;Spherical mesh requires </span><span class="se">\&#39;</span><span class="s1">rt-dg</span><span class="se">\&#39;</span><span class="s1"> or </span><span class="se">\&#39;</span><span class="s1">bdm-dg</span><span class="se">\&#39;</span><span class="s1"> &#39;</span> \
                <span class="s1">&#39;element family.&#39;</span>
        <span class="c1"># ----- function spaces: elev in H, uv in U, mixed is W</span>
        <span class="n">DG</span> <span class="o">=</span> <span class="s1">&#39;DG&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="o">.</span><span class="n">cellname</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;triangle&#39;</span> <span class="k">else</span> <span class="s1">&#39;DQ&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P0_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">DG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P0_2d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1_2d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1v_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1v_2d&#39;</span><span class="p">,</span>
                                                        <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">DG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1DG_2d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DGv_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">DG</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1DGv_2d&#39;</span><span class="p">,</span>
                                                          <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># 2D velocity space</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rt-dg&#39;</span><span class="p">,</span> <span class="s1">&#39;bdm-dg&#39;</span><span class="p">]:</span>
            <span class="n">family_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">family_suffix</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;triangle&#39;</span><span class="p">:</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;quadrilateral&#39;</span><span class="p">:</span> <span class="s1">&#39;CF&#39;</span><span class="p">}</span>
            <span class="n">cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="o">.</span><span class="n">cellname</span><span class="p">()</span>
            <span class="n">fam</span> <span class="o">=</span> <span class="n">family_prefix</span> <span class="o">+</span> <span class="n">family_suffix</span><span class="p">[</span><span class="n">cell</span><span class="p">]</span>
            <span class="n">degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">fam</span><span class="p">,</span> <span class="n">degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_2d&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">DG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;H_2d&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;dg-cg&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">DG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_2d&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;H_2d&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;dg-dg&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">DG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_2d&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">DG</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;H_2d&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unsupported finite element family </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">V_2d</span> <span class="o">=</span> <span class="n">MixedFunctionSpace</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="p">])</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_element_family</span> <span class="o">==</span> <span class="s1">&#39;dg&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">Q_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Q_2d&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_element_family</span> <span class="o">==</span> <span class="s1">&#39;cg&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">Q_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Q_2d&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unsupported finite element family </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_element_family</span><span class="p">))</span></div>


<div class="viewcode-block" id="FlowSolver2d.add_new_field">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.add_new_field">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.add_new_field&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_new_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">shortname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">preproc_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a field to :attr:`fields`.</span>

<span class="sd">        :arg function: representation of the field as a :class:`Function`</span>
<span class="sd">        :arg label: field label used internally by Thetis, e.g. &#39;tracer_2d&#39;</span>
<span class="sd">        :arg name: human readable name for the tracer field, e.g. &#39;Tracer concentration&#39;</span>
<span class="sd">        :arg filename: file name for outputs, e.g. &#39;Tracer2d&#39;</span>
<span class="sd">        :kwarg shortname: short version of name, e.g. &#39;Tracer&#39;</span>
<span class="sd">        :kwarg unit: units for field, e.g. &#39;-&#39;</span>
<span class="sd">        :kwarg preproc_func: optional pre-processor function which will be called before exporting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">shortname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shortname</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">preproc_func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">callable</span><span class="p">(</span><span class="n">preproc_func</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_metadata</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39; already exists.&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label</span><span class="p">,</span> <span class="s2">&quot;Labels cannot contain spaces&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;Filenames cannot contain spaces&quot;</span>
        <span class="n">field_metadata</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;shortname&#39;</span><span class="p">:</span> <span class="n">shortname</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span>
        <span class="k">if</span> <span class="n">preproc_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_field_preproc_funcs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">preproc_func</span></div>


<div class="viewcode-block" id="FlowSolver2d.create_fields">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.create_fields">[docs]</a>
    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.create_fields&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates field Functions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">,</span> <span class="s1">&#39;U_2d&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_function_spaces</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">log_output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">no_exports</span><span class="p">:</span>
            <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">keep_log</span> <span class="k">else</span> <span class="s2">&quot;w&quot;</span>
            <span class="n">set_log_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">mode</span><span class="p">)</span>

        <span class="c1"># Add general fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span>
        <span class="n">get_horizontal_elem_size_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_wetting_and_drying_alpha</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">DepthExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">,</span>
                                     <span class="n">use_nonlinear_equations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_nonlinear_equations</span><span class="p">,</span>
                                     <span class="n">use_wetting_and_drying</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_wetting_and_drying</span><span class="p">,</span>
                                     <span class="n">wetting_and_drying_alpha</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wetting_and_drying_alpha</span><span class="p">)</span>

        <span class="c1"># Add fields for shallow water modelling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">V_2d</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;solution_2d&#39;</span><span class="p">)</span>
        <span class="n">uv_2d</span><span class="p">,</span> <span class="n">elev_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">subfunctions</span>  <span class="c1"># correct treatment of the split 2d functions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span> <span class="o">=</span> <span class="n">uv_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span> <span class="o">=</span> <span class="n">elev_2d</span>

        <span class="c1"># Add tracer fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_tracer</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">system</span><span class="p">,</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_fields</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">system</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
            <span class="n">num_labels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">Q_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">Q_2d</span>
                <span class="n">fs</span> <span class="o">=</span> <span class="n">Q_2d</span> <span class="k">if</span> <span class="n">num_labels</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">MixedFunctionSpace</span><span class="p">([</span><span class="n">Q_2d</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">labels</span><span class="p">))</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">num_labels</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">system</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_fields</span><span class="p">[</span><span class="n">system</span><span class="p">]</span> <span class="o">=</span> <span class="n">parent</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="k">if</span> <span class="n">num_labels</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">parent</span><span class="o">.</span><span class="n">subfunctions</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">children</span><span class="p">):</span>
                <span class="n">tracer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer</span><span class="p">[</span><span class="n">label</span><span class="p">]</span>
                <span class="n">function</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_new_field</span><span class="p">(</span><span class="n">function</span><span class="p">,</span>
                                   <span class="n">label</span><span class="p">,</span>
                                   <span class="n">tracer</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                                   <span class="n">tracer</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">],</span>
                                   <span class="n">shortname</span><span class="o">=</span><span class="n">tracer</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;shortname&#39;</span><span class="p">],</span>
                                   <span class="n">unit</span><span class="o">=</span><span class="n">tracer</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;unit&#39;</span><span class="p">])</span>

        <span class="c1"># Add suspended sediment field</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">solve_suspended_sediment</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">sediment_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">Q_2d</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;sediment_2d&#39;</span><span class="p">)</span>

        <span class="c1"># Add fields for non-hydrostatic mode</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">solve_nonhydrostatic_pressure</span><span class="p">:</span>
            <span class="n">q_degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">q_degree</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">q_degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">q_degree</span>
            <span class="n">fs_q</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="n">q_degree</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">q_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs_q</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;q_2d&#39;</span><span class="p">)</span>  <span class="c1"># 2D non-hydrostatic pressure at bottom</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">w_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;w_2d&#39;</span><span class="p">)</span>  <span class="c1"># depth-averaged vertical velocity</span></div>


<div class="viewcode-block" id="FlowSolver2d.create_equations">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.create_equations">[docs]</a>
    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.create_equations&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates equation instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="s1">&#39;uv_2d&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_fields</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equations</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">()</span>

        <span class="c1"># tidal farms, if any</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tidal_turbine_farms</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">discrete_tidal_turbine_farms</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tidal_farms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span>
            <span class="n">quad_degree</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">farm_options_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tidal_turbine_farms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">farm_options_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Farm options must be entered as a list e.g. &quot;</span> \
                                <span class="s2">&quot;solver2d.FlowSolver2d(mesh2d, bathymetry_2d).options.discrete_tidal_turbine_farms[site_ID] = &quot;</span> \
                                <span class="s2">&quot;[farm_options]&quot;</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">farm_options</span> <span class="ow">in</span> <span class="n">farm_options_list</span><span class="p">:</span>
                    <span class="n">fdx</span> <span class="o">=</span> <span class="n">dx</span><span class="p">(</span><span class="n">subdomain</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">quad_degree</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tidal_farms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">TidalTurbineFarm</span><span class="p">(</span><span class="n">farm_options</span><span class="o">.</span><span class="n">turbine_density</span><span class="p">,</span> <span class="n">fdx</span><span class="p">,</span> <span class="n">farm_options</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">subdomain</span><span class="p">,</span> <span class="n">farm_options_list</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">discrete_tidal_turbine_farms</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">farm_options_list</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="n">error_msg</span> <span class="o">=</span> <span class="s2">&quot;Farm options must be entered as a list e.g. &quot;</span> \
                                <span class="s2">&quot;solver2d.FlowSolver2d(mesh2d, bathymetry_2d).options.discrete_tidal_turbine_farms[site_ID] = &quot;</span> \
                                <span class="s2">&quot;[farm_options]&quot;</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">farm_options</span> <span class="ow">in</span> <span class="n">farm_options_list</span><span class="p">:</span>
                    <span class="n">fdx</span> <span class="o">=</span> <span class="n">dx</span><span class="p">(</span><span class="n">subdomain</span><span class="p">,</span> <span class="n">degree</span><span class="o">=</span><span class="n">farm_options</span><span class="o">.</span><span class="n">quadrature_degree</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tidal_farms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DiscreteTidalTurbineFarm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">fdx</span><span class="p">,</span> <span class="n">farm_options</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tidal_farms</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Shallow water equations for hydrodynamic modelling</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">sw</span> <span class="o">=</span> <span class="n">shallowwater_eq</span><span class="o">.</span><span class="n">ShallowWaterEquations</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
            <span class="n">tidal_farms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tidal_farms</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">sw</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;shallow_water&#39;</span><span class="p">]</span>
        <span class="n">uv_2d</span><span class="p">,</span> <span class="n">elev_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">subfunctions</span>

        <span class="c1"># Passive tracer equations</span>
        <span class="k">for</span> <span class="n">system</span><span class="p">,</span> <span class="n">parent</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_fields</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">[</span><span class="n">system</span><span class="p">]</span> <span class="o">=</span> <span class="n">tracer_eq_2d</span><span class="o">.</span><span class="n">TracerEquation2D</span><span class="p">(</span>
                <span class="n">system</span><span class="p">,</span>
                <span class="n">parent</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                <span class="n">uv_2d</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Equation for suspended sediment transport</span>
        <span class="n">sediment_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span>
        <span class="k">if</span> <span class="n">sediment_options</span><span class="o">.</span><span class="n">solve_suspended_sediment</span> <span class="ow">or</span> <span class="n">sediment_options</span><span class="o">.</span><span class="n">solve_exner</span><span class="p">:</span>
            <span class="n">sediment_model_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">sediment_model_class</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sediment_model</span> <span class="o">=</span> <span class="n">sediment_model_class</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">uv_2d</span><span class="p">,</span> <span class="n">elev_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sediment_options</span><span class="o">.</span><span class="n">solve_suspended_sediment</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">sediment</span> <span class="o">=</span> <span class="n">sediment_eq_2d</span><span class="o">.</span><span class="n">SedimentEquation2D</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">Q_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment_model</span><span class="p">,</span>
                <span class="n">conservative</span><span class="o">=</span><span class="n">sediment_options</span><span class="o">.</span><span class="n">use_sediment_conservative_form</span><span class="p">)</span>

        <span class="c1"># Exner equation for bedload transport</span>
        <span class="k">if</span> <span class="n">sediment_options</span><span class="o">.</span><span class="n">solve_exner</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">element_continuity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">())</span><span class="o">.</span><span class="n">horizontal</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cg&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">exner</span> <span class="o">=</span> <span class="n">exner_eq</span><span class="o">.</span><span class="n">ExnerEquation</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                    <span class="n">depth_integrated_sediment</span><span class="o">=</span><span class="n">sediment_options</span><span class="o">.</span><span class="n">use_sediment_conservative_form</span><span class="p">,</span> <span class="n">sediment_model</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sediment_model</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;Exner equation can currently only be implemented if the bathymetry is defined on a continuous space&quot;</span><span class="p">)</span>

        <span class="c1"># Free surface equation for non-hydrostatic pressure</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">solve_nonhydrostatic_pressure</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;Using non-hydrostatic pressure&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">fs</span> <span class="o">=</span> <span class="n">shallowwater_eq</span><span class="o">.</span><span class="n">FreeSurfaceEquation</span><span class="p">(</span>
                <span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">fs</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;shallow_water&#39;</span><span class="p">]</span>

        <span class="c1"># Setup slope limiters</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_tracer</span> <span class="ow">or</span> <span class="n">sediment_options</span><span class="o">.</span><span class="n">solve_suspended_sediment</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_limiter_for_tracers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracer_limiter</span> <span class="o">=</span> <span class="n">limiter</span><span class="o">.</span><span class="n">VertexBasedP1DGLimiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">Q_2d</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tracer_limiter</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="FlowSolver2d.get_swe_timestepper">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.get_swe_timestepper">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.get_swe_timestepper&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_swe_timestepper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integrator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets shallow water timestepper object with appropriate parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;linear_drag_coefficient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">linear_drag_coefficient</span><span class="p">,</span>
            <span class="s1">&#39;quadratic_drag_coefficient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">quadratic_drag_coefficient</span><span class="p">,</span>
            <span class="s1">&#39;manning_drag_coefficient&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">manning_drag_coefficient</span><span class="p">,</span>
            <span class="s1">&#39;nikuradse_bed_roughness&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nikuradse_bed_roughness</span><span class="p">,</span>
            <span class="s1">&#39;viscosity_h&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">horizontal_viscosity</span><span class="p">,</span>
            <span class="s1">&#39;lax_friedrichs_velocity_scaling_factor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">lax_friedrichs_velocity_scaling_factor</span><span class="p">,</span>
            <span class="s1">&#39;coriolis&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">coriolis_frequency</span><span class="p">,</span>
            <span class="s1">&#39;wind_stress&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wind_stress</span><span class="p">,</span>
            <span class="s1">&#39;atmospheric_pressure&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">atmospheric_pressure</span><span class="p">,</span>
            <span class="s1">&#39;momentum_source&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">momentum_source_2d</span><span class="p">,</span>
            <span class="s1">&#39;volume_source&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">volume_source_2d</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">bnd_conditions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;shallow_water&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">swe_timestepper_type</span> <span class="o">==</span> <span class="s1">&#39;PressureProjectionPicard&#39;</span><span class="p">:</span>
            <span class="n">u_test</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">mom</span> <span class="o">=</span> <span class="n">shallowwater_eq</span><span class="o">.</span><span class="n">ShallowWaterMomentumEquation</span><span class="p">(</span>
                <span class="n">u_test</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span>
                <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">,</span>
                <span class="n">tidal_farms</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tidal_farms</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">mom</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="n">bnd_conditions</span>
            <span class="k">return</span> <span class="n">integrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">sw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">mom</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="p">,</span>
                              <span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">swe_timestepper_options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">integrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">sw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">swe_timestepper_options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowSolver2d.get_tracer_timestepper">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.get_tracer_timestepper">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.get_tracer_timestepper&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_tracer_timestepper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integrator</span><span class="p">,</span> <span class="n">system</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets tracer timestepper object with appropriate parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uv</span><span class="p">,</span> <span class="n">elev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">subfunctions</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;elev_2d&#39;</span><span class="p">:</span> <span class="n">elev</span><span class="p">,</span>
            <span class="s1">&#39;uv_2d&#39;</span><span class="p">:</span> <span class="n">uv</span><span class="p">,</span>
            <span class="s1">&#39;lax_friedrichs_tracer_scaling_factor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">lax_friedrichs_tracer_scaling_factor</span><span class="p">,</span>
            <span class="s1">&#39;tracer_advective_velocity_factor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_advective_velocity_factor</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">system</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">):</span>
            <span class="n">fields</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;diffusivity_h-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">diffusivity</span>
            <span class="n">fields</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;source-</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">source</span>
        <span class="n">bcs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">system</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">:</span>
            <span class="n">bcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="n">system</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">system</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">:</span>
            <span class="c1"># TODO: Is this safe for monolithic systems?</span>
            <span class="n">bcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="n">system</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span>
        <span class="c1"># TODO: Different timestepper options for different systems</span>
        <span class="k">return</span> <span class="n">integrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="p">[</span><span class="n">system</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">system</span><span class="p">],</span> <span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_timestepper_options</span><span class="p">,</span> <span class="n">bcs</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowSolver2d.get_sediment_timestepper">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.get_sediment_timestepper">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.get_sediment_timestepper&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_sediment_timestepper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integrator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets sediment timestepper object with appropriate parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uv</span><span class="p">,</span> <span class="n">elev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">subfunctions</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;elev_2d&#39;</span><span class="p">:</span> <span class="n">elev</span><span class="p">,</span>
            <span class="s1">&#39;uv_2d&#39;</span><span class="p">:</span> <span class="n">uv</span><span class="p">,</span>
            <span class="s1">&#39;diffusivity_h-sediment_2d&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">horizontal_diffusivity</span><span class="p">,</span>
            <span class="s1">&#39;lax_friedrichs_tracer_scaling_factor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">lax_friedrichs_tracer_scaling_factor</span><span class="p">,</span>
            <span class="s1">&#39;tracer_advective_velocity_factor&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment_model</span><span class="o">.</span><span class="n">get_advective_velocity_correction_factor</span><span class="p">(),</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">integrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">sediment</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">sediment_2d</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">sediment_timestepper_options</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;sediment&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="FlowSolver2d.get_exner_timestepper">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.get_exner_timestepper">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.get_exner_timestepper&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_exner_timestepper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integrator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets exner timestepper object with appropriate parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uv</span><span class="p">,</span> <span class="n">elev</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">subfunctions</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">solve_suspended_sediment</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">sediment_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">elev</span><span class="o">.</span><span class="n">function_space</span><span class="p">())</span><span class="o">.</span><span class="n">interpolate</span><span class="p">(</span><span class="n">Constant</span><span class="p">(</span><span class="mf">0.0</span><span class="p">))</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;elev_2d&#39;</span><span class="p">:</span> <span class="n">elev</span><span class="p">,</span>
            <span class="s1">&#39;sediment&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">sediment_2d</span><span class="p">,</span>
            <span class="s1">&#39;morfac&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">morphological_acceleration_factor</span><span class="p">,</span>
            <span class="s1">&#39;porosity&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">porosity</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="c1"># only pass SWE bcs, used to determine closed boundaries in bedload term</span>
        <span class="k">return</span> <span class="n">integrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">exner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">exner_timestepper_options</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;shallow_water&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="FlowSolver2d.get_fs_timestepper">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.get_fs_timestepper">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.get_fs_timestepper&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_fs_timestepper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">integrator</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gets free-surface correction timestepper object with appropriate parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fields_fs</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;uv&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span><span class="p">,</span>
            <span class="s1">&#39;volume_source&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">volume_source_2d</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">integrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">fs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span><span class="p">,</span> <span class="n">fields_fs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">free_surface_timestepper_options</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;shallow_water&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="FlowSolver2d.create_timestepper">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.create_timestepper">[docs]</a>
    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.create_timestepper&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_timestepper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates time stepper instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;equations&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_equations</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">compute_mesh_stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_time_step</span><span class="p">()</span>

        <span class="c1"># ----- Time integrators</span>
        <span class="n">steppers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;SSPRK33&#39;</span><span class="p">:</span> <span class="n">rungekutta</span><span class="o">.</span><span class="n">SSPRK33</span><span class="p">,</span>
            <span class="s1">&#39;ForwardEuler&#39;</span><span class="p">:</span> <span class="n">timeintegrator</span><span class="o">.</span><span class="n">ForwardEuler</span><span class="p">,</span>
            <span class="s1">&#39;SteadyState&#39;</span><span class="p">:</span> <span class="n">timeintegrator</span><span class="o">.</span><span class="n">SteadyState</span><span class="p">,</span>
            <span class="s1">&#39;BackwardEuler&#39;</span><span class="p">:</span> <span class="n">rungekutta</span><span class="o">.</span><span class="n">BackwardEulerUForm</span><span class="p">,</span>
            <span class="s1">&#39;DIRK22&#39;</span><span class="p">:</span> <span class="n">rungekutta</span><span class="o">.</span><span class="n">DIRK22UForm</span><span class="p">,</span>
            <span class="s1">&#39;DIRK33&#39;</span><span class="p">:</span> <span class="n">rungekutta</span><span class="o">.</span><span class="n">DIRK33UForm</span><span class="p">,</span>
            <span class="s1">&#39;CrankNicolson&#39;</span><span class="p">:</span> <span class="n">timeintegrator</span><span class="o">.</span><span class="n">CrankNicolson</span><span class="p">,</span>
            <span class="s1">&#39;PressureProjectionPicard&#39;</span><span class="p">:</span> <span class="n">timeintegrator</span><span class="o">.</span><span class="n">PressureProjectionPicard</span><span class="p">,</span>
            <span class="s1">&#39;SSPIMEX&#39;</span><span class="p">:</span> <span class="n">implicitexplicit</span><span class="o">.</span><span class="n">IMEXLPUM2</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">solve_nonhydrostatic_pressure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poisson_solver</span> <span class="o">=</span> <span class="n">DepthIntegratedPoissonSolver</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">q_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">w_2d</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">,</span>
                <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">solver_parameters</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span> <span class="o">=</span> <span class="n">coupled_timeintegrator_2d</span><span class="o">.</span><span class="n">NonHydrostaticTimeIntegrator2D</span><span class="p">(</span>
                <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="n">steppers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">swe_timestepper_type</span><span class="p">],</span>
                <span class="n">steppers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">nh_model_options</span><span class="o">.</span><span class="n">free_surface_timestepper_type</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">solve_tracer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span> <span class="o">=</span> <span class="n">coupled_timeintegrator_2d</span><span class="o">.</span><span class="n">GeneralCoupledTimeIntegrator2D</span><span class="p">(</span>
                <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="p">{</span>
                    <span class="s1">&#39;shallow_water&#39;</span><span class="p">:</span> <span class="n">steppers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">swe_timestepper_type</span><span class="p">],</span>
                    <span class="s1">&#39;tracer&#39;</span><span class="p">:</span> <span class="n">steppers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_timestepper_type</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">solve_suspended_sediment</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">solve_exner</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span> <span class="o">=</span> <span class="n">coupled_timeintegrator_2d</span><span class="o">.</span><span class="n">GeneralCoupledTimeIntegrator2D</span><span class="p">(</span>
                <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span> <span class="p">{</span>
                    <span class="s1">&#39;shallow_water&#39;</span><span class="p">:</span> <span class="n">steppers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">swe_timestepper_type</span><span class="p">],</span>
                    <span class="s1">&#39;sediment&#39;</span><span class="p">:</span> <span class="n">steppers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">sediment_timestepper_type</span><span class="p">],</span>
                    <span class="s1">&#39;exner&#39;</span><span class="p">:</span> <span class="n">steppers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">exner_timestepper_type</span><span class="p">],</span>
                <span class="p">},</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_swe_timestepper</span><span class="p">(</span><span class="n">steppers</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">swe_timestepper_type</span><span class="p">])</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;Using time integrator: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="p">))</span></div>


<div class="viewcode-block" id="FlowSolver2d.create_exporters">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.create_exporters">[docs]</a>
    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.create_exporters&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_exporters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates file exporters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;timestepper&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_timestepper</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">no_exports</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">ExportManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">fields_to_export</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                       <span class="n">field_metadata</span><span class="p">,</span>
                                       <span class="n">export_type</span><span class="o">=</span><span class="s1">&#39;vtk&#39;</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                       <span class="n">preproc_funcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_field_preproc_funcs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;vtk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">hdf5_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;hdf5&#39;</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">ExportManager</span><span class="p">(</span><span class="n">hdf5_dir</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">fields_to_export_hdf5</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                       <span class="n">field_metadata</span><span class="p">,</span>
                                       <span class="n">export_type</span><span class="o">=</span><span class="s1">&#39;hdf5&#39;</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                       <span class="n">preproc_funcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_field_preproc_funcs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;hdf5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span></div>


<div class="viewcode-block" id="FlowSolver2d.initialize">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates function spaces, equations, time stepper and exporters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">,</span> <span class="s1">&#39;U_2d&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_function_spaces</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;equations&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_equations</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;timestepper&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_timestepper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exporters&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_exporters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="FlowSolver2d.assign_initial_conditions">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.assign_initial_conditions">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.assign_initial_conditions&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">assign_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uv</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sediment</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">tracers</span><span class="p">):</span>
<span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigns initial conditions</span>

<span class="sd">        :kwarg elev: Initial condition for water elevation</span>
<span class="sd">        :type elev: scalar :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg uv: Initial condition for depth averaged velocity</span>
<span class="sd">        :type uv: vector valued :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg sediment: Initial condition for sediment concantration</span>
<span class="sd">        :type sediment: scalar valued :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg tracers: Initial conditions for tracer fields</span>
<span class="sd">        :type tracers: scalar valued :class:`Function`\s, :class:`Constant`\s, or an expressions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="n">uv_2d</span><span class="p">,</span> <span class="n">elev_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">subfunctions</span>
        <span class="k">if</span> <span class="n">elev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">elev_2d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">elev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uv</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">uv_2d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">tracers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">l</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">==</span> <span class="s1">&#39;_2d&#39;</span> <span class="k">else</span> <span class="n">l</span> <span class="o">+</span> <span class="s1">&#39;_2d&#39;</span>
            <span class="k">assert</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Unknown tracer label </span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">label</span><span class="p">]</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

        <span class="n">sediment_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment_model</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># update sediment model based on initial conditions for uv and elev</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sediment_model</span><span class="o">.</span><span class="n">update</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sediment_options</span><span class="o">.</span><span class="n">solve_suspended_sediment</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sediment</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">sediment_2d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">sediment</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sediment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sediment_model</span><span class="o">.</span><span class="n">get_equilibrium_tracer</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">sediment_options</span><span class="o">.</span><span class="n">use_sediment_conservative_form</span><span class="p">:</span>
                    <span class="n">sediment</span> <span class="o">=</span> <span class="n">sediment</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="o">.</span><span class="n">get_total_depth</span><span class="p">(</span><span class="n">elev_2d</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">sediment_2d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">sediment</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowSolver2d.add_callback">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.add_callback">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.add_callback&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds callback to solver object</span>

<span class="sd">        :arg callback: :class:`.DiagnosticCallback` instance</span>
<span class="sd">        :kwarg string eval_interval: Determines when callback will be evaluated,</span>
<span class="sd">            either &#39;export&#39; or &#39;timestep&#39; for evaluating after each export or</span>
<span class="sd">            time step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">eval_interval</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowSolver2d.export">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.export">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.export&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export all fields to disk</span>

<span class="sd">        Also evaluates all callbacks set to &#39;export&#39; interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">e</span><span class="o">.</span><span class="n">export</span><span class="p">()</span></div>


<div class="viewcode-block" id="FlowSolver2d.load_state">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.load_state">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.load_state&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">load_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stored</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">i_export</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">legacy_mode</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads simulation state from hdf5 outputs.</span>

<span class="sd">        Replaces :meth:`.assign_initial_conditions` in model initialization.</span>

<span class="sd">        For example, continue simulation from export 40,</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            solver_obj.load_state(40)</span>

<span class="sd">        Continue simulation from another output directory,</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            solver_obj.load_state(40, outputdir=&#39;outputs_spinup&#39;)</span>

<span class="sd">        Continue simulation from another output directory and reset the</span>
<span class="sd">        counters,</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            solver_obj.load_state(40, outputdir=&#39;outputs_spinup&#39;,</span>
<span class="sd">                iteration=0, t=0, i_export=0)</span>

<span class="sd">        Model state can be loaded if all prognostic state variables have been</span>
<span class="sd">        stored in hdf5 format. For the hydrodynamics the required state</span>
<span class="sd">        variables are: `elev_2d`, and `uv_2d`.</span>

<span class="sd">        Simulation time and iteration can be recovered automatically provided</span>
<span class="sd">        that the model setup is the same (e.g. time step and export_time).</span>

<span class="sd">        :arg int i_stored: export index to load</span>
<span class="sd">        :kwarg string outputdir: (optional) directory where files are read from.</span>
<span class="sd">            By default ``options.output_directory``.</span>
<span class="sd">        :kwarg float t: simulation time. Overrides the time stamp inferred from</span>
<span class="sd">            model options.</span>
<span class="sd">        :kwarg int iteration: Overrides the iteration count inferred from model</span>
<span class="sd">            options.</span>
<span class="sd">        :kwarg int i_export: Set initial export index for the present run. By</span>
<span class="sd">            default, `i_stored` is used.</span>
<span class="sd">        :kwarg bool legacy_mode: Load legacy `DumbCheckpoint` files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">outputdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outputdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span>
        <span class="c1"># create new ExportManager with desired outputdir</span>
        <span class="n">state_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uv_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;elev_2d&#39;</span><span class="p">]</span>
        <span class="n">hdf5_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s1">&#39;hdf5&#39;</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">ExportManager</span><span class="p">(</span><span class="n">hdf5_dir</span><span class="p">,</span>
                                   <span class="n">state_fields</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                   <span class="n">field_metadata</span><span class="p">,</span>
                                   <span class="n">export_type</span><span class="o">=</span><span class="s1">&#39;hdf5&#39;</span><span class="p">,</span>
                                   <span class="n">legacy_mode</span><span class="o">=</span><span class="n">legacy_mode</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;uv_2d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_stored</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;elev_2d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_stored</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assign_initial_conditions</span><span class="p">()</span>

        <span class="c1"># time stepper bookkeeping for export time step</span>
        <span class="k">if</span> <span class="n">i_export</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">i_export</span> <span class="o">=</span> <span class="n">i_stored</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span> <span class="o">=</span> <span class="n">i_export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iteration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">=</span> <span class="n">t</span>

        <span class="c1"># for next export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_initial_state</span> <span class="o">=</span> <span class="n">outputdir</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_initial_state</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">e</span><span class="o">.</span><span class="n">set_next_export_ix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_export</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span></div>


<div class="viewcode-block" id="FlowSolver2d.print_state">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.print_state">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cputime</span><span class="p">,</span> <span class="n">print_header</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a summary of the model state on stdout</span>

<span class="sd">        :arg float cputime: Measured CPU time in seconds</span>
<span class="sd">        :kwarg print_header: Whether to print column header first</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># list of entries to print: (header, value, format)</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;exp&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span><span class="p">,</span> <span class="s1">&#39;5d&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;iter&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">,</span> <span class="s1">&#39;5d&#39;</span><span class="p">),</span>
        <span class="p">]</span>
        <span class="c1"># generate simulation time string</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_initial_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">now</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_initial_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span><span class="p">)</span>
            <span class="n">date_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">now</span><span class="si">:</span><span class="s1">%Y-%m-%d</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
            <span class="n">time_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">now</span><span class="si">:</span><span class="s1">%H:%M:%S</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="n">entries</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;date&#39;</span><span class="p">,</span> <span class="n">date_str</span><span class="p">,</span> <span class="s1">&#39;11s&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">time_str</span><span class="p">,</span> <span class="s1">&#39;9s&#39;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">time_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">entries</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">time_str</span><span class="p">,</span> <span class="s1">&#39;15s&#39;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer_only</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer</span><span class="p">:</span>
                <span class="n">norm_q</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">label</span><span class="p">])</span>
                <span class="n">e</span> <span class="o">=</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">norm_q</span><span class="p">,</span> <span class="s1">&#39;10.4f&#39;</span><span class="p">)</span>
                <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">norm_h</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">subfunctions</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">norm_u</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">subfunctions</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">entries</span> <span class="o">+=</span> <span class="p">[</span>
                <span class="p">(</span><span class="s1">&#39;eta norm&#39;</span><span class="p">,</span> <span class="n">norm_h</span><span class="p">,</span> <span class="s1">&#39;14.4f&#39;</span><span class="p">),</span>
                <span class="p">(</span><span class="s1">&#39;u norm&#39;</span><span class="p">,</span> <span class="n">norm_u</span><span class="p">,</span> <span class="s1">&#39;14.4f&#39;</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Tcpu&#39;</span><span class="p">,</span> <span class="n">cputime</span><span class="p">,</span> <span class="s1">&#39;6.2f&#39;</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">print_header</span><span class="p">:</span>
            <span class="c1"># generate header</span>
            <span class="n">header</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:{</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}}</span><span class="s1">&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">])</span>
            <span class="n">print_output</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># generate line</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="si">:{</span><span class="n">e</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="si">}}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">])</span>
        <span class="n">print_output</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>


<div class="viewcode-block" id="FlowSolver2d.iterate">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.iterate">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.iterate&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the simulation</span>

<span class="sd">        Wrapper for function for `create_iterator` generator and automatically</span>
<span class="sd">        iterates over the time loop until time ``options.simulation_end_time`` is reached.</span>
<span class="sd">        Exports fields to disk on ``options.simulation_export_time`` intervals.</span>

<span class="sd">        :kwarg update_forcings: User-defined function that takes simulation</span>
<span class="sd">            time as an argument and updates time-dependent boundary conditions</span>
<span class="sd">            (if any).</span>
<span class="sd">        :kwarg export_func: User-defined function (with no arguments) that will</span>
<span class="sd">            be called on every export.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_iterator</span><span class="p">(</span><span class="n">update_forcings</span><span class="o">=</span><span class="n">update_forcings</span><span class="p">,</span>
                                      <span class="n">export_func</span><span class="o">=</span><span class="n">export_func</span><span class="p">):</span>
            <span class="k">pass</span></div>


<div class="viewcode-block" id="FlowSolver2d.create_iterator">
<a class="viewcode-back" href="../../thetis.html#thetis.solver2d.FlowSolver2d.create_iterator">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver2d.create_iterator&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">export_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates a generator to iterate through the simulation and return access</span>
<span class="sd">        to time advancing function when time control is handled externally.</span>

<span class="sd">        Iterates over the time loop until time ``options.simulation_end_time`` is reached.</span>
<span class="sd">        Exports fields to disk on ``options.simulation_export_time`` intervals.</span>

<span class="sd">        For example:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            for t in solver_obj.create_iterator():</span>
<span class="sd">                # user code</span>

<span class="sd">        or, to get per time-step control:</span>

<span class="sd">        .. code-block:: python</span>

<span class="sd">            thetis_timestepper = solver_obj.create_iterator()</span>

<span class="sd">            while t_Thetis&lt;t_end - timestep and .... :</span>
<span class="sd">                t_Thetis = next(thetis_timestepper)</span>

<span class="sd">        :kwarg update_forcings: User-defined function that takes simulation</span>
<span class="sd">            time as an argument and updates time-dependent boundary conditions</span>
<span class="sd">            (if any).</span>
<span class="sd">        :kwarg export_func: User-defined function (with no arguments) that will</span>
<span class="sd">            be called on every export.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_limiter_for_tracers</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">t_epsilon</span> <span class="o">=</span> <span class="mf">1.0e-5</span>
        <span class="n">cputimestamp</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">next_export_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>

        <span class="n">dump_hdf5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">export_diagnostics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">no_exports</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_volume_conservation_2d</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">VolumeConservation2DCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                      <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                      <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_tracer_conservation</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">tracer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">tracer</span><span class="o">.</span><span class="n">use_conservative_form</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">ConservativeTracerMassConservation2DCallback</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                                                              <span class="bp">self</span><span class="p">,</span>
                                                                              <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                                              <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">TracerMassConservation2DCallback</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                                                  <span class="bp">self</span><span class="p">,</span>
                                                                  <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                                  <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">check_sediment_conservation</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">use_sediment_conservative_form</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">ConservativeTracerMassConservation2DCallback</span><span class="p">(</span><span class="s1">&#39;sediment_2d&#39;</span><span class="p">,</span>
                                                                          <span class="bp">self</span><span class="p">,</span>
                                                                          <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                                          <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">TracerMassConservation2DCallback</span><span class="p">(</span><span class="s1">&#39;sediment_2d&#39;</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="p">,</span>
                                                              <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                              <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_tracer_overshoot</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">tracer</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">TracerOvershootCallBack</span><span class="p">(</span><span class="n">label</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="p">,</span>
                                                     <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                     <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sediment_model_options</span><span class="o">.</span><span class="n">check_sediment_overshoot</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">TracerOvershootCallBack</span><span class="p">(</span><span class="s1">&#39;sediment_2d&#39;</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="p">,</span>
                                                 <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                 <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>

        <span class="n">initial_simulation_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span>
        <span class="n">internal_iteration</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">init_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_initial_date</span>
        <span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_end_date</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">init_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">end_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">now</span> <span class="o">=</span> <span class="n">init_date</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">initial_simulation_time</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">end_date</span> <span class="o">&gt;</span> <span class="n">now</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;Simulation end date must be greater than initial time </span><span class="si">{</span><span class="n">now</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="n">print_output</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Running simulation</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39; from </span><span class="si">{</span><span class="n">now</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S %Z</span><span class="si">}</span><span class="se">\n</span><span class="s1">&#39;</span>
                <span class="sa">f</span><span class="s1">&#39; to   </span><span class="si">{</span><span class="n">end_date</span><span class="si">:</span><span class="s1">%Y-%m-%d %H:%M:%S %Z</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
            <span class="n">end_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">now</span><span class="p">)</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">+</span> <span class="n">initial_simulation_time</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Both simulation_end_date and simulation_end_time have been set, ignoring simulation_end_time.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_end_time</span> <span class="o">=</span> <span class="n">end_time</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_end_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;simulation_end_time must be set&#39;</span>

        <span class="c1"># initial export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_state</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">print_header</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_initial_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">export_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">export_func</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;vtk&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;vtk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">export_bathymetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">)</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_end_time</span> <span class="o">-</span> <span class="n">t_epsilon</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span>

            <span class="c1"># returns internal simulation time</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span>

            <span class="c1"># Move to next time step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">internal_iteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">=</span> <span class="n">initial_simulation_time</span> <span class="o">+</span> <span class="n">internal_iteration</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;timestep&#39;</span><span class="p">)</span>

            <span class="c1"># Write the solution to file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">&gt;=</span> <span class="n">next_export_t</span> <span class="o">-</span> <span class="n">t_epsilon</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">next_export_t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>

                <span class="n">cputime</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">cputimestamp</span>
                <span class="n">cputimestamp</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_state</span><span class="p">(</span><span class="n">cputime</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">export_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">export_func</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span></div>
</div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
    </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2016-2025, Tuomas Kärnä et al..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>