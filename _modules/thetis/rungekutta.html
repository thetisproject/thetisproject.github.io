<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>thetis.rungekutta &#8212; Thetis 0+untagged.2082.gf1a0bbb documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/thetis.css?v=0f3339d6" />
    <script src="../../_static/documentation_options.js?v=ccd1159c"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<!-- <link rel="stylesheet" href="../../_static/featured.css"> -->


<link rel="shortcut icon" href="../../_static/icon_thetis.ico" />


  </head><body>
<div class="wrapper">
  <a href="../../index.html"><img src="../../_static/banner.jpg" height="180px" alt="Thetis Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
        <li class="page_item"><a href="../../documentation.html" title="Thetis documentation">Documentation</a></li>
        <li class="page_item"><a href="../../download.html" title="Install Thetis">Download</a></li>
        <li class="page_item"><a href="../../team.html" title="Development team">Team</a></li>
        <li class="page_item"><a href="../../publications.html" title="Publications">Publications</a></li>
        <li class="page_item"><a href="../../funding.html" title="Our financial supporters">Funding</a></li>
        <li class="page_item"><a href="../../contact.html" title="Getting in touch">Contact</a></li>
        <li class="page_item"><a href="https://github.com/thetisproject/thetis" title="Thetis source on GitHub">GitHub</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
    <div class="_modules/thetis/rungekutta">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thetis.rungekutta</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implements Runge-Kutta time integration methods.</span>

<span class="sd">The abstract class :class:`~.AbstractRKScheme` defines the Runge-Kutta</span>
<span class="sd">coefficients, and can be used to implement generic time integrators.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.timeintegrator</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">abc</span><span class="w"> </span><span class="kn">import</span> <span class="n">ABC</span><span class="p">,</span> <span class="n">abstractproperty</span><span class="p">,</span> <span class="n">abstractmethod</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">operator</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>


<div class="viewcode-block" id="butcher_to_shuosher_form">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.butcher_to_shuosher_form">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">butcher_to_shuosher_form</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts Butcher tableau to Shu-Osher form.</span>

<span class="sd">    The Shu-Osher form of a s-stage scheme is defined by two s+1 by s+1 arrays</span>
<span class="sd">    :math:`\alpha` and :math:`\beta`:</span>

<span class="sd">    .. math::</span>
<span class="sd">        u^{0} &amp;= u^n \\</span>
<span class="sd">        u^{(i)} &amp;= \sum_{j=0}^s \alpha_{i,j} u^{(j)} + \sum_{j=0}^s \beta_{i,j} F(u^{(j)}) \\</span>
<span class="sd">        u^{n+1} &amp;= u^{(s)}</span>

<span class="sd">    The Shu-Osher form is not unique. Here we construct the form where beta</span>
<span class="sd">    values are the diagonal entries (for DIRK schemes) or sub-diagonal entries</span>
<span class="sd">    (for explicit schemes) of the concatenated Butcher tableau [:math:`a`; :math:`b`].</span>

<span class="sd">    For more information see Ketchelson et al. (2009) http://dx.doi.org/10.1016/j.apnum.2008.03.034</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">numpy.linalg</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">linalg</span>

    <span class="n">butcher</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>

    <span class="n">implicit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">implicit</span><span class="p">:</span>
        <span class="c1"># a is not singular</span>
        <span class="c1"># take diag entries of a to beta</span>
        <span class="n">be_0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">be_1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="n">be_1</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">be</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">be_0</span><span class="p">,</span> <span class="n">be_1</span><span class="p">))</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iden</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">al_0</span> <span class="o">=</span> <span class="n">iden</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">be_0</span><span class="p">,</span> <span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
        <span class="n">al_1</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">b</span> <span class="o">-</span> <span class="n">be_1</span><span class="p">),</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">be_0</span><span class="p">),</span> <span class="p">(</span><span class="n">iden</span> <span class="o">-</span> <span class="n">al_0</span><span class="p">)))</span>
        <span class="n">al</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">al_0</span><span class="p">,</span> <span class="n">al_1</span><span class="p">))</span>

        <span class="c1"># construct full shu-osher form</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">alpha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">al</span>
        <span class="c1"># consistency</span>
        <span class="n">alpha</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">be</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># a is singular: solve for lower part of butcher tableau</span>
        <span class="n">aa</span> <span class="o">=</span> <span class="n">butcher</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
        <span class="c1"># take diag entries of aa to beta</span>
        <span class="n">be_0</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">aa</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">iden</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
        <span class="n">al_0</span> <span class="o">=</span> <span class="n">iden</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">be_0</span><span class="p">,</span> <span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">aa</span><span class="p">))</span>

        <span class="c1"># construct full shu-osher form</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">alpha</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">al_0</span>
        <span class="c1"># consistency</span>
        <span class="n">alpha</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">be_0</span>

    <span class="c1"># round off small entries</span>
    <span class="n">alpha</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-13</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">beta</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e-13</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="c1"># check sanity</span>
    <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">implicit</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="p">(</span><span class="n">butcher</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">alpha</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:],</span> <span class="n">a</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">err</span> <span class="o">=</span> <span class="n">beta</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">butcher</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">alpha</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">a</span><span class="p">))</span>
    <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">err</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span></div>



<div class="viewcode-block" id="AbstractRKScheme">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.AbstractRKScheme">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AbstractRKScheme</span><span class="p">(</span><span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Abstract class for defining Runge-Kutta schemes.</span>

<span class="sd">    Derived classes must define the Butcher tableau (arrays :attr:`a`, :attr:`b`,</span>
<span class="sd">    :attr:`c`) and the CFL number (:attr:`cfl_coeff`).</span>

<span class="sd">    Currently only explicit or diagonally implicit schemes are supported.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@abstractproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Runge-Kutta matrix :math:`a_{i,j}` of the Butcher tableau&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">b</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;weights :math:`b_{i}` of the Butcher tableau&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">c</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;nodes :math:`c_{i}` of the Butcher tableau&quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="nd">@abstractproperty</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cfl_coeff</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        CFL number of the scheme</span>

<span class="sd">        Value 1.0 corresponds to Forward Euler time step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">)</span>

        <span class="k">assert</span> <span class="ow">not</span> <span class="n">numpy</span><span class="o">.</span><span class="n">triu</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">(),</span> <span class="s1">&#39;Butcher tableau must be lower diagonal&#39;</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">),</span> <span class="s1">&#39;Inconsistent Butcher tableau: Row sum of a is not c&#39;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">butcher</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_implicit</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">is_dirk</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dirk</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_implicit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">beta</span> <span class="o">=</span> <span class="n">butcher_to_shuosher_form</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span></div>



<div class="viewcode-block" id="ForwardEulerAbstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ForwardEulerAbstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ForwardEulerAbstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Forward Euler method</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.0</span></div>



<div class="viewcode-block" id="BackwardEulerAbstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.BackwardEulerAbstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BackwardEulerAbstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Backward Euler method</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">1.0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span></div>



<div class="viewcode-block" id="ImplicitMidpointAbstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ImplicitMidpointAbstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImplicitMidpointAbstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implicit midpoint method, second order.</span>

<span class="sd">    This method has the Butcher tableau</span>

<span class="sd">    .. math::</span>
<span class="sd">        \begin{array}{c|c}</span>
<span class="sd">        0.5 &amp; 0.5 \\ \hline</span>
<span class="sd">            &amp; 1.0</span>
<span class="sd">        \end{array}</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span></div>



<div class="viewcode-block" id="CrankNicolsonAbstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.CrankNicolsonAbstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CrankNicolsonAbstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Crack-Nicolson scheme</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span></div>



<div class="viewcode-block" id="DIRK22Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK22Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK22Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    2-stage, 2nd order, L-stable Diagonally Implicit Runge Kutta method</span>

<span class="sd">    This method has the Butcher tableau</span>

<span class="sd">    .. math::</span>
<span class="sd">        \begin{array}{c|cc}</span>
<span class="sd">        \gamma &amp;   \gamma &amp;       0 \\</span>
<span class="sd">              1 &amp; 1-\gamma &amp; \gamma \\ \hline</span>
<span class="sd">                &amp;       1/2 &amp;     1/2</span>
<span class="sd">        \end{array}</span>

<span class="sd">    with :math:`\gamma = (2 - \sqrt{2})/2`.</span>

<span class="sd">    From DIRK(2,3,2) IMEX scheme in Ascher et al. (1997)</span>

<span class="sd">    Ascher et al. (1997). Implicit-explicit Runge-Kutta methods for</span>
<span class="sd">    time-dependent partial differential equations. Applied Numerical</span>
<span class="sd">    Mathematics, 25:151-167. http://dx.doi.org/10.1137/0732037</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span><span class="p">))</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">gamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">gamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span></div>



<div class="viewcode-block" id="DIRK23Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK23Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK23Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    2-stage, 3rd order Diagonally Implicit Runge Kutta method</span>

<span class="sd">    This method has the Butcher tableau</span>

<span class="sd">    .. math::</span>
<span class="sd">        \begin{array}{c|cc}</span>
<span class="sd">          \gamma &amp;    \gamma &amp;       0 \\</span>
<span class="sd">        1-\gamma &amp; 1-2\gamma &amp; \gamma \\ \hline</span>
<span class="sd">                  &amp;        1/2 &amp;     1/2</span>
<span class="sd">        \end{array}</span>

<span class="sd">    with :math:`\gamma = (3 + \sqrt{3})/6`.</span>

<span class="sd">    From DIRK(2,3,3) IMEX scheme in Ascher et al. (1997)</span>

<span class="sd">    Ascher et al. (1997). Implicit-explicit Runge-Kutta methods for</span>
<span class="sd">    time-dependent partial differential equations. Applied Numerical</span>
<span class="sd">    Mathematics, 25:151-167. http://dx.doi.org/10.1137/0732037</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">+</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span><span class="o">/</span><span class="mi">6</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">gamma</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">gamma</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span></div>



<div class="viewcode-block" id="DIRK33Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK33Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK33Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3-stage, 3rd order, L-stable Diagonally Implicit Runge Kutta method</span>

<span class="sd">    From DIRK(3,4,3) IMEX scheme in Ascher et al. (1997)</span>

<span class="sd">    Ascher et al. (1997). Implicit-explicit Runge-Kutta methods for</span>
<span class="sd">    time-dependent partial differential equations. Applied Numerical</span>
<span class="sd">    Mathematics, 25:151-167. http://dx.doi.org/10.1137/0732037</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="mf">0.4358665215</span>
    <span class="n">b1</span> <span class="o">=</span> <span class="o">-</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gamma</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">gamma</span> <span class="o">-</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">4.0</span>
    <span class="n">b2</span> <span class="o">=</span> <span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">gamma</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">5</span><span class="o">*</span><span class="n">gamma</span> <span class="o">+</span> <span class="mf">5.0</span><span class="o">/</span><span class="mf">4.0</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[(</span><span class="mi">1</span><span class="o">-</span><span class="n">gamma</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">,</span> <span class="n">gamma</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">gamma</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">gamma</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span></div>



<div class="viewcode-block" id="DIRK43Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK43Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK43Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    4-stage, 3rd order, L-stable Diagonally Implicit Runge Kutta method</span>

<span class="sd">    From DIRK(4,4,3) IMEX scheme in Ascher et al. (1997)</span>

<span class="sd">    Ascher et al. (1997). Implicit-explicit Runge-Kutta methods for</span>
<span class="sd">    time-dependent partial differential equations. Applied Numerical</span>
<span class="sd">    Mathematics, 25:151-167. http://dx.doi.org/10.1137/0732037</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span></div>



<div class="viewcode-block" id="DIRKLSPUM2Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKLSPUM2Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRKLSPUM2Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DIRKLSPUM2, 3-stage, 2nd order, L-stable Diagonally Implicit Runge Kutta method</span>

<span class="sd">    From IMEX RK scheme (17) in Higureras et al. (2014).</span>

<span class="sd">    Higueras et al (2014). Optimized strong stability preserving IMEX</span>
<span class="sd">    Runge-Kutta methods. Journal of Computational and Applied Mathematics</span>
<span class="sd">    272(2014) 116-140. http://dx.doi.org/10.1016/j.cam.2014.05.011</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">205.0</span><span class="o">/</span><span class="mf">462.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">2033.0</span><span class="o">/</span><span class="mf">4620.0</span><span class="p">,</span> <span class="mf">21.0</span><span class="o">/</span><span class="mf">110.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">24.0</span><span class="o">/</span><span class="mf">55.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mf">289.0</span><span class="o">/</span><span class="mf">462.0</span><span class="p">,</span> <span class="mf">751.0</span><span class="o">/</span><span class="mf">924.0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">4.34</span>  <span class="c1"># NOTE for linear problems, nonlin =&gt; 3.82</span></div>



<div class="viewcode-block" id="DIRKLPUM2Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKLPUM2Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRKLPUM2Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DIRKLPUM2, 3-stage, 2nd order, L-stable Diagonally Implicit Runge Kutta method</span>

<span class="sd">    From IMEX RK scheme (20) in Higureras et al. (2014).</span>

<span class="sd">    Higueras et al (2014). Optimized strong stability preserving IMEX</span>
<span class="sd">    Runge-Kutta methods. Journal of Computational and Applied Mathematics</span>
<span class="sd">    272(2014) 116-140. http://dx.doi.org/10.1016/j.cam.2014.05.011</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">41.0</span><span class="o">/</span><span class="mf">154.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">289.0</span><span class="o">/</span><span class="mf">847.0</span><span class="p">,</span> <span class="mf">42.0</span><span class="o">/</span><span class="mf">121.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">2.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">,</span> <span class="mf">69.0</span><span class="o">/</span><span class="mf">154.0</span><span class="p">,</span> <span class="mf">67.0</span><span class="o">/</span><span class="mf">77.0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">4.34</span>  <span class="c1"># NOTE for linear problems, nonlin =&gt; 3.09</span></div>



<div class="viewcode-block" id="SSPRK33Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK33Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SSPRK33Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    3rd order Strong Stability Preserving Runge-Kutta scheme, SSP(3,3).</span>

<span class="sd">    This scheme has Butcher tableau</span>

<span class="sd">    .. math::</span>
<span class="sd">        \begin{array}{c|ccc}</span>
<span class="sd">            0 &amp;                 \\</span>
<span class="sd">            1 &amp; 1               \\</span>
<span class="sd">          1/2 &amp; 1/4 &amp; 1/4 &amp;     \\ \hline</span>
<span class="sd">              &amp; 1/6 &amp; 1/6 &amp; 2/3</span>
<span class="sd">        \end{array}</span>

<span class="sd">    CFL coefficient is 1.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.0</span></div>



<div class="viewcode-block" id="ERKLSPUM2Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKLSPUM2Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKLSPUM2Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ERKLSPUM2, 3-stage, 2nd order Explicit Runge Kutta method</span>

<span class="sd">    From IMEX RK scheme (17) in Higureras et al. (2014).</span>

<span class="sd">    Higueras et al (2014). Optimized strong stability preserving IMEX</span>
<span class="sd">    Runge-Kutta methods. Journal of Computational and Applied Mathematics</span>
<span class="sd">    272(2014) 116-140. http://dx.doi.org/10.1016/j.cam.2014.05.011</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">5.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">11.0</span><span class="o">/</span><span class="mf">24.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="o">/</span><span class="mf">24.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">24.0</span><span class="o">/</span><span class="mf">55.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="o">/</span><span class="mf">11.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">5.0</span><span class="o">/</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.2</span></div>



<div class="viewcode-block" id="ERKLPUM2Abstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKLPUM2Abstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKLPUM2Abstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    ERKLPUM2, 3-stage, 2nd order</span>
<span class="sd">    Explicit Runge Kutta method</span>

<span class="sd">    From IMEX RK scheme (20) in Higureras et al. (2014).</span>

<span class="sd">    Higueras et al (2014). Optimized strong stability preserving IMEX</span>
<span class="sd">    Runge-Kutta methods. Journal of Computational and Applied Mathematics</span>
<span class="sd">    272(2014) 116-140. http://dx.doi.org/10.1016/j.cam.2014.05.011</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">2.0</span></div>



<div class="viewcode-block" id="ERKMidpointAbstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKMidpointAbstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKMidpointAbstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.0</span></div>



<div class="viewcode-block" id="ESDIRKMidpointAbstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ESDIRKMidpointAbstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ESDIRKMidpointAbstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="mf">1.0</span></div>



<div class="viewcode-block" id="ESDIRKTrapezoidAbstract">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ESDIRKTrapezoidAbstract">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ESDIRKTrapezoidAbstract</span><span class="p">(</span><span class="n">AbstractRKScheme</span><span class="p">):</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
         <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]]</span>
    <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]</span>
    <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span></div>



<div class="viewcode-block" id="RungeKuttaTimeIntegrator">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.RungeKuttaTimeIntegrator">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RungeKuttaTimeIntegrator</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">,</span> <span class="n">ABC</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Abstract base class for all Runge-Kutta time integrators&quot;&quot;&quot;</span>
<div class="viewcode-block" id="RungeKuttaTimeIntegrator.get_final_solution">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.RungeKuttaTimeIntegrator.get_final_solution">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_final_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the final solution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="RungeKuttaTimeIntegrator.solve_stage">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.RungeKuttaTimeIntegrator.solve_stage">[docs]</a>
    <span class="nd">@abstractmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves a single stage of step from t to t+dt.</span>
<span class="sd">        All functions that the equation depends on must be at right state</span>
<span class="sd">        corresponding to each sub-step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="RungeKuttaTimeIntegrator.advance">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.RungeKuttaTimeIntegrator.advance">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_final_solution</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="DIRKGeneric">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGeneric">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRKGeneric</span><span class="p">(</span><span class="n">RungeKuttaTimeIntegrator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic implementation of Diagonally Implicit Runge Kutta schemes.</span>

<span class="sd">    All derived classes must define the Butcher tableau coefficients :attr:`a`,</span>
<span class="sd">    :attr:`b`, :attr:`c`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGeneric.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">,</span> <span class="n">terms_to_add</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: the equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        :kwarg terms_to_add: Defines which terms of the equation are to be</span>
<span class="sd">            added to this solver. Default &#39;all&#39; implies [&#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;].</span>
<span class="sd">        :type terms_to_add: &#39;all&#39; or list of &#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">semi_implicit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">options</span><span class="p">,</span> <span class="s1">&#39;use_semi_implicit_linearization&#39;</span><span class="p">):</span>
            <span class="n">semi_implicit</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">use_semi_implicit_linearization</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;old solution&#39;</span><span class="p">)</span>

        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">test</span>
        <span class="n">mixed_space</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

        <span class="c1"># Allocate tendency fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_k</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">fname</span><span class="p">))</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span>
        <span class="n">u_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="c1"># linearize around last timestep using the fact that all terms are</span>
            <span class="c1"># written in the form A(u_nl) u</span>
            <span class="n">u_nl</span> <span class="o">=</span> <span class="n">u_old</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solve the full nonlinear residual form</span>
            <span class="n">u_nl</span> <span class="o">=</span> <span class="n">u</span>

        <span class="c1"># construct variational problems</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">mixed_space</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="n">u_old</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
                              <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">terms_to_add</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_nl</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solution must be split before computing sum</span>
            <span class="c1"># pass components to equation in a list</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">u</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># list of components in the mixed space</span>
                        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="n">u_old</span><span class="p">),</span> <span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                            <span class="n">u</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">])):</span>
                            <span class="n">u</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="n">k</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
                              <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">terms_to_add</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_nl</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

        <span class="c1"># construct expressions for stage solutions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_stage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">sol_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[:</span><span class="n">i_stage</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i_stage</span><span class="p">][:</span><span class="n">i_stage</span><span class="o">+</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol_expr</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final_sol_expr</span> <span class="o">=</span> <span class="n">u_old</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>

<div class="viewcode-block" id="DIRKGeneric.update_solver">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGeneric.update_solver">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGeneric.update_solver&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create solver objects&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_stage</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">NonlinearVariationalSolver</span><span class="p">(</span><span class="n">p</span><span class="p">,</span>
                                           <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                           <span class="n">options_prefix</span><span class="o">=</span><span class="n">sname</span><span class="p">,</span>
                                           <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_stage</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="DIRKGeneric.initialize">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGeneric.initialize">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGeneric.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_cond</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">init_cond</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="DIRKGeneric.update_solution">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGeneric.update_solution">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGeneric.update_solution&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates solution to i_stage sub-stage.</span>

<span class="sd">        Tendencies must have been evaluated first.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span><span class="p">[</span><span class="n">i_stage</span><span class="p">])</span></div>


<div class="viewcode-block" id="DIRKGeneric.solve_tendency">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGeneric.solve_tendency">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGeneric.solve_tendency&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_tendency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the tendency of i-th stage.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># NOTE solution may have changed in coupled system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Time integrator </span><span class="si">{:}</span><span class="s1"> is not initialized&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span></div>


<div class="viewcode-block" id="DIRKGeneric.get_final_solution">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGeneric.get_final_solution">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGeneric.get_final_solution&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_final_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign final solution to :attr:`self.solution`&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">final_sol_expr</span><span class="p">)</span></div>


<div class="viewcode-block" id="DIRKGeneric.solve_stage">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGeneric.solve_stage">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGeneric.solve_stage&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve i-th stage and assign solution to :attr:`self.solution`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_tendency</span><span class="p">(</span><span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_solution</span><span class="p">(</span><span class="n">i_stage</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="DIRKGenericUForm">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGenericUForm">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRKGenericUForm</span><span class="p">(</span><span class="n">RungeKuttaTimeIntegrator</span><span class="p">):</span>
    <span class="n">cfl_coeff</span> <span class="o">=</span> <span class="n">CFL_UNCONDITIONALLY_STABLE</span>

    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGenericUForm.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">,</span> <span class="n">terms_to_add</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: the equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        :kwarg terms_to_add: Defines which terms of the equation are to be</span>
<span class="sd">            added to this solver. Default &#39;all&#39; implies [&#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;].</span>
<span class="sd">        :type terms_to_add: &#39;all&#39; or list of &#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="n">semi_implicit</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">use_semi_implicit_linearization</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;snes_type&#39;</span><span class="p">,</span> <span class="s1">&#39;newtonls&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;solution_old&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="c1"># assume final stage is trivial</span>
        <span class="k">assert</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>

        <span class="n">fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span>
        <span class="n">test</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">test</span>

        <span class="c1"># Allocate tendency fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">fname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_k</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">fname</span><span class="p">))</span>

        <span class="n">u</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span>
        <span class="n">u_old</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span>
        <span class="k">if</span> <span class="n">semi_implicit</span><span class="p">:</span>
            <span class="c1"># linearize around last timestep using the fact that all terms are</span>
            <span class="c1"># written in the form A(u_nl) u</span>
            <span class="n">u_nl</span> <span class="o">=</span> <span class="n">u_old</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># solve the full nonlinear residual form</span>
            <span class="n">u_nl</span> <span class="o">=</span> <span class="n">u</span>
        <span class="n">bnd</span> <span class="o">=</span> <span class="n">bnd_conditions</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>

        <span class="c1"># construct variational problems for each stage</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">F</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">mass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u_old</span><span class="p">)</span>
            <span class="n">rhs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">u_nl</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">bnd</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">rhs</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mass</span> <span class="o">-</span> <span class="n">rhs</span><span class="p">)</span>

        <span class="c1"># construct variational problems to evaluate tendencies</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_form</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">kf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span> <span class="o">-</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="n">u_old</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
                <span class="n">kf</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="o">*</span><span class="n">inner</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">test</span><span class="p">)</span><span class="o">*</span><span class="n">dx</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_form</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">kf</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="DIRKGenericUForm.update_solver">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGenericUForm.update_solver">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGenericUForm.update_solver&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create solver objects&quot;&quot;&quot;</span>
        <span class="c1"># Ensure LU assembles monolithic matrices</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pc_type&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;lu&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">[</span><span class="s1">&#39;mat_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;aij&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">F</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
            <span class="n">sname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_stage</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                <span class="n">options_prefix</span><span class="o">=</span><span class="n">sname</span><span class="p">,</span>
                <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_stage</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_solver</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">k_solver_parameters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;snes_type&#39;</span><span class="p">:</span> <span class="s1">&#39;ksponly&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ksp_type&#39;</span><span class="p">:</span> <span class="s1">&#39;cg&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ksp_rtol&#39;</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">NonlinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">k_form</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">sname</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">_k_stage</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">_&#39;</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">NonlinearVariationalSolver</span><span class="p">(</span>
                <span class="n">p</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="n">k_solver_parameters</span><span class="p">,</span>
                <span class="n">options_prefix</span><span class="o">=</span><span class="n">sname</span><span class="p">,</span>
                <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_k_stage</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_solver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>


<div class="viewcode-block" id="DIRKGenericUForm.initialize">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGenericUForm.initialize">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGenericUForm.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">init_cond</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">init_cond</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="DIRKGenericUForm.get_final_solution">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGenericUForm.get_final_solution">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_final_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the final solution</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DIRKGenericUForm.solve_stage">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKGenericUForm.solve_stage">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.DIRKGenericUForm.solve_stage&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Solves a single stage of step from t to t+dt.</span>
<span class="sd">        All functions that the equation depends on must be at right state</span>
<span class="sd">        corresponding to each sub-step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># NOTE solution may have changed in coupled system</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="n">error</span><span class="p">(</span><span class="s1">&#39;Time integrator </span><span class="si">{:}</span><span class="s1"> is not initialized&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">i_stage</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">k_solver</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="BackwardEuler">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.BackwardEuler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BackwardEuler</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">BackwardEulerAbstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ImplicitMidpoint">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ImplicitMidpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImplicitMidpoint</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">ImplicitMidpointAbstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="CrankNicolsonRK">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.CrankNicolsonRK">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CrankNicolsonRK</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">CrankNicolsonAbstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DIRK22">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK22">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK22</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">DIRK22Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DIRK23">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK23">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK23</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">DIRK23Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DIRK33">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK33">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK33</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">DIRK33Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DIRK43">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK43">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK43</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">DIRK43Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DIRKLSPUM2">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKLSPUM2">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRKLSPUM2</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">DIRKLSPUM2Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DIRKLPUM2">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRKLPUM2">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRKLPUM2</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">DIRKLPUM2Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="BackwardEulerUForm">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.BackwardEulerUForm">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">BackwardEulerUForm</span><span class="p">(</span><span class="n">DIRKGenericUForm</span><span class="p">,</span> <span class="n">BackwardEulerAbstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DIRK22UForm">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK22UForm">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK22UForm</span><span class="p">(</span><span class="n">DIRKGenericUForm</span><span class="p">,</span> <span class="n">DIRK22Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="DIRK33UForm">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.DIRK33UForm">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DIRK33UForm</span><span class="p">(</span><span class="n">DIRKGenericUForm</span><span class="p">,</span> <span class="n">DIRK33Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ERKGeneric">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGeneric">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKGeneric</span><span class="p">(</span><span class="n">RungeKuttaTimeIntegrator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic explicit Runge-Kutta time integrator.</span>

<span class="sd">    Implements the Butcher form. All terms in the equation are treated explicitly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGeneric.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">,</span> <span class="n">terms_to_add</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: the equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        :kwarg terms_to_add: Defines which terms of the equation are to be</span>
<span class="sd">            added to this solver. Default &#39;all&#39; implies [&#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;].</span>
<span class="sd">        :type terms_to_add: &#39;all&#39; or list of &#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ERKGeneric</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;old solution&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">k</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tendency</span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>

        <span class="c1"># fully explicit evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">terms_to_add</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_rk</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># construct expressions for stage solutions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i_stage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
                <span class="n">sol_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="p">[:</span><span class="n">i_stage</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">a</span><span class="p">[</span><span class="n">i_stage</span><span class="p">][:</span><span class="n">i_stage</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol_expr</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_sol_expr</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="ERKGeneric.update_solver">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGeneric.update_solver">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGeneric.update_solver&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
                <span class="n">prob</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                <span class="n">solver</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_k</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                                 <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                                 <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span> <span class="o">+</span> <span class="sa">f</span><span class="s1">&#39;_k</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">solver</span><span class="p">)</span></div>


<div class="viewcode-block" id="ERKGeneric.initialize">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGeneric.initialize">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGeneric.initialize&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assigns initial conditions to all required fields.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">solution</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="ERKGeneric.update_solution">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGeneric.update_solution">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGeneric.update_solution&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">additive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes the solution of the i-th stage</span>

<span class="sd">        Tendencies must have been evaluated first.</span>

<span class="sd">        If additive=False, will overwrite :attr:`solution` function, otherwise</span>
<span class="sd">        will add to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">additive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span> <span class="ow">and</span> <span class="n">i_stage</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span></div>


<div class="viewcode-block" id="ERKGeneric.solve_tendency">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGeneric.solve_tendency">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGeneric.solve_tendency&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_tendency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Evaluates the tendency of i-th stage</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span></div>


<div class="viewcode-block" id="ERKGeneric.get_final_solution">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGeneric.get_final_solution">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGeneric.get_final_solution&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_final_solution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">additive</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Assign final solution to :attr:`self.solution`</span>

<span class="sd">        If additive=False, will overwrite :attr:`solution` function, otherwise</span>
<span class="sd">        will add to it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">additive</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_sol_expr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solution_old</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span></div>


<div class="viewcode-block" id="ERKGeneric.solve_stage">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGeneric.solve_stage">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGeneric.solve_stage&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve i-th stage and assign solution to :attr:`self.solution`.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_solution</span><span class="p">(</span><span class="n">i_stage</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">solve_tendency</span><span class="p">(</span><span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="ERKGenericShuOsher">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGenericShuOsher">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKGenericShuOsher</span><span class="p">(</span><span class="n">TimeIntegrator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generic explicit Runge-Kutta time integrator.</span>

<span class="sd">    Implements the Shu-Osher form.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGenericShuOsher.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">,</span> <span class="n">bnd_conditions</span><span class="p">,</span> <span class="n">terms_to_add</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg equation: the equation to solve</span>
<span class="sd">        :type equation: :class:`Equation` object</span>
<span class="sd">        :arg solution: :class:`Function` where solution will be stored</span>
<span class="sd">        :arg fields: Dictionary of fields that are passed to the equation</span>
<span class="sd">        :type fields: dict of :class:`Function` or :class:`Constant` objects</span>
<span class="sd">        :arg float dt: time step in seconds</span>
<span class="sd">        :arg options: :class:`TimeStepperOptions` instance containing parameter values.</span>
<span class="sd">        :arg dict bnd_conditions: Dictionary of boundary conditions passed to the equation</span>
<span class="sd">        :kwarg terms_to_add: Defines which terms of the equation are to be</span>
<span class="sd">            added to this solver. Default &#39;all&#39; implies [&#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;].</span>
<span class="sd">        :type terms_to_add: &#39;all&#39; or list of &#39;implicit&#39;, &#39;explicit&#39;, &#39;source&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ERKGenericShuOsher</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">equation</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;tendency&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage_sol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">function_space</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;sol</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">stage_sol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="c1"># fully explicit evaluation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">mass_term</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">trial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l_rk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_const</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">equation</span><span class="o">.</span><span class="n">residual</span><span class="p">(</span><span class="n">terms_to_add</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">,</span>
                                                         <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                                         <span class="n">bnd_conditions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_rk</span> <span class="o">!=</span> <span class="mi">0</span>

        <span class="c1"># construct expressions for stage solutions</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">i_stage</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
                <span class="n">sol_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="n">i_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][</span><span class="n">i_stage</span><span class="p">]</span> <span class="o">+</span> <span class="nb">sum</span><span class="p">(</span>
                    <span class="nb">map</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage_sol</span><span class="p">[:</span><span class="n">i_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">i_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">][:</span><span class="n">i_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sol_expr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">update_solver</span><span class="p">()</span>

<div class="viewcode-block" id="ERKGenericShuOsher.update_solver">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGenericShuOsher.update_solver">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGenericShuOsher.update_solver&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_solver</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="n">prob</span> <span class="o">=</span> <span class="n">LinearVariationalProblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">a_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">l_rk</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tendency</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span> <span class="o">=</span> <span class="n">LinearVariationalSolver</span><span class="p">(</span><span class="n">prob</span><span class="p">,</span> <span class="n">options_prefix</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;_k&#39;</span><span class="p">,</span>
                                                  <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">,</span>
                                                  <span class="n">ad_block_tag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ad_block_tag</span> <span class="o">+</span> <span class="s1">&#39;_k&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="ERKGenericShuOsher.initialize">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGenericShuOsher.initialize">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">solution</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="ERKGenericShuOsher.solve_stage">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGenericShuOsher.solve_stage">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGenericShuOsher.solve_stage&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">solve_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_stage</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Solve i-th stage and assign solution to :attr:`self.solution`.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nontrivial</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">update_forcings</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">update_forcings</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">i_stage</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i_stage</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stage_sol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span>

            <span class="c1"># solve tendency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solver</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

            <span class="c1"># solve the next internal solution</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sol_expressions</span><span class="p">[</span><span class="n">i_stage</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">i_stage</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stage_sol</span><span class="p">[</span><span class="n">i_stage</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">solution</span><span class="p">)</span></div>


<div class="viewcode-block" id="ERKGenericShuOsher.advance">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKGenericShuOsher.advance">[docs]</a>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.ERKGenericShuOsher.advance&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">advance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Advances equations for one time step.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_stages</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">solve_stage</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">update_forcings</span><span class="p">)</span></div>
</div>



<div class="viewcode-block" id="SSPRK33">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.SSPRK33">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">SSPRK33</span><span class="p">(</span><span class="n">ERKGenericShuOsher</span><span class="p">,</span> <span class="n">SSPRK33Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ERKLSPUM2">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKLSPUM2">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKLSPUM2</span><span class="p">(</span><span class="n">ERKGeneric</span><span class="p">,</span> <span class="n">ERKLSPUM2Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ERKLPUM2">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKLPUM2">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKLPUM2</span><span class="p">(</span><span class="n">ERKGeneric</span><span class="p">,</span> <span class="n">ERKLPUM2Abstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ERKMidpoint">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKMidpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKMidpoint</span><span class="p">(</span><span class="n">ERKGeneric</span><span class="p">,</span> <span class="n">ERKMidpointAbstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ESDIRKMidpoint">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ESDIRKMidpoint">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ESDIRKMidpoint</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">ESDIRKMidpointAbstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ESDIRKTrapezoid">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ESDIRKTrapezoid">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ESDIRKTrapezoid</span><span class="p">(</span><span class="n">DIRKGeneric</span><span class="p">,</span> <span class="n">ESDIRKTrapezoidAbstract</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ERKEuler">
<a class="viewcode-back" href="../../thetis.html#thetis.coupled_timeintegrator.ERKEuler">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ERKEuler</span><span class="p">(</span><span class="n">ERKGeneric</span><span class="p">,</span> <span class="n">ForwardEulerAbstract</span><span class="p">):</span>
    <span class="k">pass</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
    </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2016-2025, Tuomas Kärnä et al..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.1.3.
    </div>
  </body>
</html>