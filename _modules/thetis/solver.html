
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>thetis.solver &#8212; Thetis 0+untagged.1888.gc4e776a documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/thetis.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<!--[if lte IE 6]>
<link rel="stylesheet" href="../../_static/ie6.css" type="text/css" media="screen" charset="utf-8" />
<![endif]-->

<!-- <link rel="stylesheet" href="../../_static/featured.css"> -->


<link rel="shortcut icon" href="../../_static/icon_thetis.ico" />


  </head><body>
<div class="wrapper">
  <a href="../../index.html"><img src="../../_static/banner.jpg" height="180px" alt="Thetis Project Banner" /></a>
  <div id="access">
    <div class="menu">
      <ul>
        <li class="page_item"><a href="../../documentation.html" title="Thetis documentation">Documentation</a></li>
        <li class="page_item"><a href="../../download.html" title="Install Thetis">Download</a></li>
        <li class="page_item"><a href="../../team.html" title="Development team">Team</a></li>
        <li class="page_item"><a href="../../publications.html" title="Publications">Publications</a></li>
        <li class="page_item"><a href="../../funding.html" title="Our financial supporters">Funding</a></li>
        <li class="page_item"><a href="../../contact.html" title="Getting in touch">Contact</a></li>
        <li class="page_item"><a href="https://github.com/thetisproject/thetis" title="Thetis source on GitHub">GitHub</a></li>
      </ul>
    </div><!-- .menu -->
  </div><!-- #access -->
</div><!-- #wrapper -->


    <div class="document">
    <div class="_modules/thetis/solver">
      
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for thetis.solver</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Module for three dimensional baroclinic solver</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">.utility</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.utility3d</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">shallowwater_eq</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">momentum_eq</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">tracer_eq</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">turbulence</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">coupled_timeintegrator</span>
<span class="kn">import</span> <span class="nn">thetis.limiter</span> <span class="k">as</span> <span class="nn">limiter</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">time_mod</span>
<span class="kn">from</span> <span class="nn">mpi4py</span> <span class="kn">import</span> <span class="n">MPI</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">exporter</span>
<span class="kn">import</span> <span class="nn">weakref</span>
<span class="kn">from</span> <span class="nn">.field_defs</span> <span class="kn">import</span> <span class="n">field_metadata</span>
<span class="kn">from</span> <span class="nn">.options</span> <span class="kn">import</span> <span class="n">ModelOptions3d</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">callback</span>
<span class="kn">from</span> <span class="nn">.log</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">numpy</span>


<div class="viewcode-block" id="FlowSolver"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver">[docs]</a><span class="k">class</span> <span class="nc">FlowSolver</span><span class="p">(</span><span class="n">FrozenClass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Main object for 3D solver</span>

<span class="sd">    **Example**</span>

<span class="sd">    Create 2D mesh</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from thetis import *</span>
<span class="sd">        mesh2d = RectangleMesh(20, 20, 10e3, 10e3)</span>

<span class="sd">    Create bathymetry function, set a constant value</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        fs_p1 = FunctionSpace(mesh2d, &#39;CG&#39;, 1)</span>
<span class="sd">        bathymetry_2d = Function(fs_p1, name=&#39;Bathymetry&#39;).assign(10.0)</span>

<span class="sd">    Create a 3D model with 6 uniform levels, and set some options</span>
<span class="sd">    (see :class:`.ModelOptions3d`)</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        solver_obj = solver.FlowSolver(mesh2d, bathymetry_2d, n_layers=6)</span>
<span class="sd">        options = solver_obj.options</span>
<span class="sd">        options.element_family = &#39;dg-dg&#39;</span>
<span class="sd">        options.polynomial_degree = 1</span>
<span class="sd">        options.timestepper_type = &#39;SSPRK22&#39;</span>
<span class="sd">        options.timestepper_options.use_automatic_timestep = False</span>
<span class="sd">        options.solve_salinity = False</span>
<span class="sd">        options.solve_temperature = False</span>
<span class="sd">        options.simulation_export_time = 50.0</span>
<span class="sd">        options.simulation_end_time = 3600.</span>
<span class="sd">        options.timestep = 25.0</span>

<span class="sd">    Assign initial condition for water elevation</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        solver_obj.create_function_spaces()</span>
<span class="sd">        init_elev = Function(solver_obj.function_spaces.H_2d)</span>
<span class="sd">        coords = SpatialCoordinate(mesh2d)</span>
<span class="sd">        init_elev.project(2.0*exp(-((coords[0] - 4e3)**2 + (coords[1] - 4.5e3)**2)/2.2e3**2))</span>
<span class="sd">        solver_obj.assign_initial_conditions(elev=init_elev)</span>

<span class="sd">    Run simulation</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        solver_obj.iterate()</span>

<span class="sd">    See the manual for more complex examples.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.__init__&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mesh2d</span><span class="p">,</span> <span class="n">bathymetry_2d</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span>
                 <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">extrude_options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :arg mesh2d: :class:`Mesh` object of the 2D mesh</span>
<span class="sd">        :arg bathymetry_2d: Bathymetry of the domain. Bathymetry stands for</span>
<span class="sd">            the mean water depth (positive downwards).</span>
<span class="sd">        :type bathymetry_2d: 2D :class:`Function`</span>
<span class="sd">        :arg int n_layers: Number of layers in the vertical direction.</span>
<span class="sd">            Elements are distributed uniformly over the vertical.</span>
<span class="sd">        :kwarg options: Model options (optional). Model options can also be</span>
<span class="sd">            changed directly via the :attr:`.options` class property.</span>
<span class="sd">        :type options: :class:`.ModelOptions3d` instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bathymetry_cg_2d</span> <span class="o">=</span> <span class="n">bathymetry_2d</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span> <span class="o">=</span> <span class="n">mesh2d</span>
        <span class="sd">&quot;&quot;&quot;2D :class`Mesh`&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">extrude_options</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">extrude_options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span> <span class="o">=</span> <span class="n">extrude_mesh_sigma</span><span class="p">(</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">n_layers</span><span class="p">,</span> <span class="n">bathymetry_2d</span><span class="p">,</span> <span class="o">**</span><span class="n">extrude_options</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;3D :class`Mesh`&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span> <span class="o">=</span> <span class="n">mesh2d</span><span class="o">.</span><span class="n">comm</span>

        <span class="c1"># add boundary length info</span>
        <span class="n">bnd_len</span> <span class="o">=</span> <span class="n">compute_boundary_length</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">boundary_len</span> <span class="o">=</span> <span class="n">bnd_len</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">boundary_len</span> <span class="o">=</span> <span class="n">bnd_len</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;Time step&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;Time of the 2D solver&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">M_modesplit</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="sd">&quot;&quot;&quot;Mode split ratio (int)&quot;&quot;&quot;</span>

        <span class="c1"># override default options</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span> <span class="o">=</span> <span class="n">ModelOptions3d</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dictionary of all options. A :class:`.ModelOptions3d` object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="c1"># simulation time step bookkeeping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;shallow_water&#39;</span><span class="p">:</span> <span class="p">{},</span>
                              <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="p">{},</span>
                              <span class="s1">&#39;salt&#39;</span><span class="p">:</span> <span class="p">{},</span>
                              <span class="s1">&#39;temp&#39;</span><span class="p">:</span> <span class="p">{},</span>
                              <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">CallbackManager</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`.CallbackManager` object that stores all callbacks</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span> <span class="o">=</span> <span class="n">FieldDict</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`.FieldDict` that holds all functions needed by the solver</span>
<span class="sd">        object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">()</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :class:`.AttrDict` that holds all function spaces needed by the</span>
<span class="sd">        solver object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">export_initial_state</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="sd">&quot;&quot;&quot;Do export initial state. False if continuing a simulation&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_continued</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_field_preproc_funcs</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="FlowSolver.compute_dx_factor"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.compute_dx_factor">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dx_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes normalized distance between nodes in the horizontal direction</span>

<span class="sd">        The factor depends on the finite element space and its polynomial</span>
<span class="sd">        degree. It is used to compute maximal stable time steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rt-dg&#39;</span><span class="p">,</span> <span class="s1">&#39;bdm-dg&#39;</span><span class="p">]:</span>
            <span class="c1"># velocity space is essentially p+1</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># assuming DG basis functions on triangles</span>
        <span class="n">l_r</span> <span class="o">=</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">3.0</span> <span class="o">+</span> <span class="mf">7.0</span><span class="o">/</span><span class="mf">6.0</span><span class="o">*</span><span class="n">p</span> <span class="o">+</span> <span class="mf">1.0</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="mf">0.25</span><span class="o">/</span><span class="n">l_r</span>
        <span class="k">return</span> <span class="n">factor</span></div>

<div class="viewcode-block" id="FlowSolver.compute_dz_factor"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.compute_dz_factor">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dz_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes a normalized distance between nodes in the vertical direction</span>

<span class="sd">        The factor depends on the finite element space and its polynomial</span>
<span class="sd">        degree. It is used to compute maximal stable time steps.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span>
        <span class="c1"># assuming DG basis functions in an interval</span>
        <span class="n">l_r</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="nb">max</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="mf">0.25</span><span class="o">/</span><span class="n">l_r</span>
        <span class="k">return</span> <span class="n">factor</span></div>

<div class="viewcode-block" id="FlowSolver.compute_dt_2d"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.compute_dt_2d">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.compute_dt_2d&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compute_dt_2d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_scale</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes maximum explicit time step from CFL condition.</span>

<span class="sd">        .. math :: \Delta t = \frac{\Delta x}{U}</span>

<span class="sd">        Assumes velocity scale :math:`U = \sqrt{g H} + U_{scale}` where</span>
<span class="sd">        :math:`U_{scale}` is estimated advective velocity.</span>

<span class="sd">        :arg u_scale: User provided maximum advective velocity scale</span>
<span class="sd">        :type u_scale: float or :class:`Constant`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">csize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span>
        <span class="n">bath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span>
        <span class="n">fs</span> <span class="o">=</span> <span class="n">bath</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span>
        <span class="n">bath_pos</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;bathymetry&#39;</span><span class="p">)</span>
        <span class="n">bath_pos</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">bath</span><span class="p">)</span>
        <span class="n">min_depth</span> <span class="o">=</span> <span class="mf">0.05</span>
        <span class="n">bath_pos</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">bath_pos</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span> <span class="o">&lt;</span> <span class="n">min_depth</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_depth</span>
        <span class="n">test</span> <span class="o">=</span> <span class="n">TestFunction</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">trial</span> <span class="o">=</span> <span class="n">TrialFunction</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">solution</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">fs</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">physical_constants</span><span class="p">[</span><span class="s1">&#39;g_grav&#39;</span><span class="p">]</span>
        <span class="n">u</span> <span class="o">=</span> <span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span> <span class="o">*</span> <span class="n">bath_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">u_scale</span><span class="p">)</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">trial</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="n">l</span> <span class="o">=</span> <span class="n">inner</span><span class="p">(</span><span class="n">test</span><span class="p">,</span> <span class="n">csize</span> <span class="o">/</span> <span class="n">u</span><span class="p">)</span> <span class="o">*</span> <span class="n">dx</span>
        <span class="n">sp</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;snes_type&quot;</span><span class="p">:</span> <span class="s2">&quot;ksponly&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ksp_type&quot;</span><span class="p">:</span> <span class="s2">&quot;cg&quot;</span><span class="p">,</span>
            <span class="s2">&quot;pc_type&quot;</span><span class="p">:</span> <span class="s2">&quot;bjacobi&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sub_pc_type&quot;</span><span class="p">:</span> <span class="s2">&quot;ilu&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">solve</span><span class="p">(</span><span class="n">a</span> <span class="o">==</span> <span class="n">l</span><span class="p">,</span> <span class="n">solution</span><span class="p">,</span> <span class="n">solver_parameters</span><span class="o">=</span><span class="n">sp</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">solution</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
        <span class="n">dt</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dx_factor</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">dt</span></div>

<div class="viewcode-block" id="FlowSolver.compute_dt_h_advection"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.compute_dt_h_advection">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dt_h_advection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u_scale</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes maximum explicit time step for horizontal advection</span>

<span class="sd">        .. math :: \Delta t = \frac{\Delta x}{U_{scale}}</span>

<span class="sd">        where :math:`U_{scale}` is estimated horizontal advective velocity.</span>

<span class="sd">        :arg u_scale: User provided maximum horizontal velocity scale</span>
<span class="sd">        :type u_scale: float or :class:`Constant`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">u_scale</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">u_scale</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
            <span class="n">u</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">u_scale</span><span class="p">)</span>
        <span class="n">min_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="c1"># alpha = 0.5 if self.options.element_family == &#39;rt-dg&#39; else 1.0</span>
        <span class="c1"># dt = alpha*1.0/10.0/(self.options.polynomial_degree + 1)*min_dx/u</span>
        <span class="n">min_dx</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dx_factor</span><span class="p">()</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">min_dx</span><span class="o">/</span><span class="n">u</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dt</span></div>

<div class="viewcode-block" id="FlowSolver.compute_dt_v_advection"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.compute_dt_v_advection">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dt_v_advection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">w_scale</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes maximum explicit time step for vertical advection</span>

<span class="sd">        .. math :: \Delta t = \frac{\Delta z}{W_{scale}}</span>

<span class="sd">        where :math:`W_{scale}` is estimated vertical advective velocity.</span>

<span class="sd">        :arg w_scale: User provided maximum vertical velocity scale</span>
<span class="sd">        :type w_scale: float or :class:`Constant`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">w_scale</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">w_scale</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">w_scale</span><span class="p">)</span>
        <span class="n">min_dz</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_2d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="c1"># alpha = 0.5 if self.options.element_family == &#39;rt-dg&#39; else 1.0</span>
        <span class="c1"># dt = alpha*1.0/1.5/(self.options.polynomial_degree + 1)*min_dz/w</span>
        <span class="n">min_dz</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dz_factor</span><span class="p">()</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="n">min_dz</span><span class="o">/</span><span class="n">w</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dt</span></div>

<div class="viewcode-block" id="FlowSolver.compute_dt_diffusion"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.compute_dt_diffusion">[docs]</a>    <span class="k">def</span> <span class="nf">compute_dt_diffusion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nu_scale</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes maximum explicit time step for horizontal diffusion.</span>

<span class="sd">        .. math :: \Delta t = \alpha \frac{(\Delta x)^2}{\nu_{scale}}</span>

<span class="sd">        where :math:`\nu_{scale}` is estimated diffusivity scale.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="n">nu_scale</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">nu_scale</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
            <span class="n">nu</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">nu_scale</span><span class="p">)</span>
        <span class="n">min_dx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">2.0</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;bdm-dg&#39;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.8</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestepper_type</span> <span class="o">==</span> <span class="s1">&#39;LeapFrog&#39;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="mf">0.6</span>
        <span class="n">min_dx</span> <span class="o">*=</span> <span class="n">factor</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_dx_factor</span><span class="p">()</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_dx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">nu</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dt</span></div>

<div class="viewcode-block" id="FlowSolver.compute_mesh_stats"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.compute_mesh_stats">[docs]</a>    <span class="k">def</span> <span class="nf">compute_mesh_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Computes number of elements, nodes etc and prints to sdtout</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nnodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">P1DG_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG_2d</span>
        <span class="n">nelem2d</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">P1DG_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span><span class="o">/</span><span class="n">P1DG_2d</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="o">.</span><span class="n">num_vertices</span><span class="p">())</span>
        <span class="n">nlayers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">layers</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">nprisms</span> <span class="o">=</span> <span class="n">nelem2d</span><span class="o">*</span><span class="n">nlayers</span>
        <span class="n">dofs_elev2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">dofs_u2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">dofs_u3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">dofs_w3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">W</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">dofs_t3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span>
        <span class="n">dofs_t3d_core</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">dofs_t3d</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">min_h_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
        <span class="n">max_h_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">MPI</span><span class="o">.</span><span class="n">MAX</span><span class="p">)</span>
        <span class="n">min_v_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
        <span class="n">max_v_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">MPI</span><span class="o">.</span><span class="n">MAX</span><span class="p">)</span>

        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Element family: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span><span class="si">}</span><span class="s1">, degree: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;2D cell type: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;2D mesh: </span><span class="si">{</span><span class="n">nnodes</span><span class="si">}</span><span class="s1"> vertices, </span><span class="si">{</span><span class="n">nelem2d</span><span class="si">}</span><span class="s1"> elements&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;3D mesh: </span><span class="si">{</span><span class="n">nlayers</span><span class="si">}</span><span class="s1"> layers, </span><span class="si">{</span><span class="n">nprisms</span><span class="si">}</span><span class="s1"> prisms&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Horizontal element size: </span><span class="si">{</span><span class="n">min_h_size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> ... </span><span class="si">{</span><span class="n">max_h_size</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1"> m&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Vertical element size: </span><span class="si">{</span><span class="n">min_v_size</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> ... </span><span class="si">{</span><span class="n">max_v_size</span><span class="si">:</span><span class="s1">.3f</span><span class="si">}</span><span class="s1"> m&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of 2D elevation DOFs: </span><span class="si">{</span><span class="n">dofs_elev2d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of 2D velocity DOFs: </span><span class="si">{</span><span class="n">dofs_u2d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of 3D h. velocity DOFs: </span><span class="si">{</span><span class="n">dofs_u3d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of 3D v. velocity DOFs: </span><span class="si">{</span><span class="n">dofs_w3d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of 3D tracer DOFs: </span><span class="si">{</span><span class="n">dofs_t3d</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Number of cores: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">size</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Tracer DOFs per core: ~</span><span class="si">{</span><span class="n">dofs_t3d_core</span><span class="si">:</span><span class="s1">.1f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="FlowSolver.set_time_step"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.set_time_step">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.set_time_step&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">set_time_step</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets the model the model time step</span>

<span class="sd">        If the time integrator supports automatic time step, and</span>
<span class="sd">        :attr:`ModelOptions3d.timestepper_options.use_automatic_timestep` is</span>
<span class="sd">        `True`, we compute the maximum time step allowed by the CFL condition.</span>
<span class="sd">        Otherwise uses :attr:`ModelOptions3d.timestep`.</span>

<span class="sd">        Once the time step is determined, will adjust it to be an integer</span>
<span class="sd">        fraction of export interval ``options.simulation_export_time``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">automatic_timestep</span> <span class="o">=</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestepper_options</span><span class="p">,</span> <span class="s1">&#39;use_automatic_timestep&#39;</span><span class="p">)</span>
                              <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestepper_options</span><span class="o">.</span><span class="n">use_automatic_timestep</span><span class="p">)</span>

        <span class="n">cfl2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">cfl_coeff_2d</span>
        <span class="n">cfl3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">cfl_coeff_3d</span>
        <span class="n">max_dt_swe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dt_2d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">horizontal_velocity_scale</span><span class="p">)</span>
        <span class="n">max_dt_hadv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dt_h_advection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">horizontal_velocity_scale</span><span class="p">)</span>
        <span class="n">max_dt_vadv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dt_v_advection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">vertical_velocity_scale</span><span class="p">)</span>
        <span class="n">max_dt_diff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_dt_diffusion</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">horizontal_viscosity_scale</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  - dt 2d swe: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_dt_swe</span><span class="p">))</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  - dt h. advection: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_dt_hadv</span><span class="p">))</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  - dt v. advection: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_dt_vadv</span><span class="p">))</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  - dt viscosity: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_dt_diff</span><span class="p">))</span>
        <span class="n">max_dt_2d</span> <span class="o">=</span> <span class="n">cfl2d</span><span class="o">*</span><span class="n">max_dt_swe</span>
        <span class="n">max_dt_3d</span> <span class="o">=</span> <span class="n">cfl3d</span><span class="o">*</span><span class="nb">min</span><span class="p">(</span><span class="n">max_dt_hadv</span><span class="p">,</span> <span class="n">max_dt_vadv</span><span class="p">,</span> <span class="n">max_dt_diff</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  - CFL adjusted dt: 2D: </span><span class="si">{:}</span><span class="s1"> 3D: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_dt_2d</span><span class="p">,</span> <span class="n">max_dt_3d</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">automatic_timestep</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  - User defined dt: 2D: </span><span class="si">{:}</span><span class="s1"> 3D: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep_2d</span>
        <span class="k">if</span> <span class="n">automatic_timestep</span><span class="p">:</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep_2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
            <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestep_2d</span> <span class="o">&gt;</span> <span class="mf">0.0</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_mode</span> <span class="o">==</span> <span class="s1">&#39;split&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">automatic_timestep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">max_dt_3d</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span> <span class="o">=</span> <span class="n">max_dt_2d</span>
            <span class="c1"># compute mode split ratio and force it to be integer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">M_modesplit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">M_modesplit</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_mode</span> <span class="o">==</span> <span class="s1">&#39;2d&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">automatic_timestep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">max_dt_2d</span><span class="p">,</span> <span class="n">max_dt_3d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">M_modesplit</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_mode</span> <span class="o">==</span> <span class="s1">&#39;3d&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">automatic_timestep</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="n">max_dt_3d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">M_modesplit</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  - chosen dt: 2D: </span><span class="si">{:}</span><span class="s1"> 3D: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>

        <span class="c1"># fit dt to export time</span>
        <span class="n">m_exp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span><span class="p">)</span><span class="o">/</span><span class="n">m_exp</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_mode</span> <span class="o">==</span> <span class="s1">&#39;split&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">M_modesplit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">M_modesplit</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span>

        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;  - adjusted dt: 2D: </span><span class="si">{:}</span><span class="s1"> 3D: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>

        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;dt = </span><span class="si">{0:f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_mode</span> <span class="o">==</span> <span class="s1">&#39;split&#39;</span><span class="p">:</span>
            <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;2D dt = </span><span class="si">{0:f}</span><span class="s1"> </span><span class="si">{1:d}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">M_modesplit</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

<div class="viewcode-block" id="FlowSolver.create_function_spaces"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.create_function_spaces">[docs]</a>    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.create_function_spaces&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_function_spaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates function spaces</span>

<span class="sd">        Function spaces are accessible via :attr:`.function_spaces`</span>
<span class="sd">        object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># ----- function spaces: elev in H, uv in U, mixed is W</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P0</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1v</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1v&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1DG&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DGv</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1DGv&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># function spaces for (u,v) and w</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rt-dg&#39;</span><span class="p">,</span> <span class="s1">&#39;bdm-dg&#39;</span><span class="p">]:</span>
            <span class="n">h_family_prefix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
            <span class="n">h_family_suffix</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;triangle&#39;</span><span class="p">:</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;quadrilateral&#39;</span><span class="p">:</span> <span class="s1">&#39;CF&#39;</span><span class="p">}</span>
            <span class="n">h_cell</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">ufl_cell</span><span class="p">()</span><span class="o">.</span><span class="n">cellname</span><span class="p">()</span>
            <span class="n">hfam</span> <span class="o">=</span> <span class="n">h_family_prefix</span> <span class="o">+</span> <span class="n">h_family_suffix</span><span class="p">[</span><span class="n">h_cell</span><span class="p">]</span>
            <span class="n">h_degree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="n">hfam</span><span class="p">,</span> <span class="n">h_degree</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="n">hdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">hdiv</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="n">hfam</span><span class="p">,</span> <span class="n">h_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_2d&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;dg-dg&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">W</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;W&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;U_2d&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unsupported finite element family </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">Uint</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span>  <span class="c1"># vertical integral of uv</span>
        <span class="c1"># tracers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;H&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P0</span>

        <span class="c1"># 2D spaces</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1_2d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1v_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1v_2d&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1DG_2d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DGv_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1DGv_2d&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;H_2d&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">V_2d</span> <span class="o">=</span> <span class="n">MixedFunctionSpace</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="p">],</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;V_2d&#39;</span><span class="p">)</span>

        <span class="c1"># define function spaces for baroclinic head and internal pressure gradient</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_quadratic_pressure</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P2DGxP2</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P2DGxP2&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P2DG_2d</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P2DG_2d&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_bhead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P2DGxP2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_bhead_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P2DG_2d</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;dg-dg&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P2DGxP1DGv</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P2DGxP1DGv&#39;</span><span class="p">,</span> <span class="n">vector</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_int_pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P2DGxP1DGv</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_int_pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DGxP2</span> <span class="o">=</span> <span class="n">get_functionspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;P1DGxP2&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_bhead</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DGxP2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_bhead_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG_2d</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_int_pg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span></div>

<div class="viewcode-block" id="FlowSolver.create_fields"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.create_fields">[docs]</a>    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.create_fields&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates all fields</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;U_2d&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_function_spaces</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">log_output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">no_exports</span><span class="p">:</span>
            <span class="n">set_log_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span><span class="p">)</span>

        <span class="c1"># mesh velocity etc fields must be in the same space as 3D coordinates</span>
        <span class="n">coord_is_dg</span> <span class="o">=</span> <span class="n">element_continuity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh2d</span><span class="o">.</span><span class="n">coordinates</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">())</span><span class="o">.</span><span class="n">horizontal</span> <span class="o">==</span> <span class="s1">&#39;dg&#39;</span>
        <span class="k">if</span> <span class="n">coord_is_dg</span><span class="p">:</span>
            <span class="n">coord_fs</span> <span class="o">=</span> <span class="n">FunctionSpace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">,</span> <span class="s1">&#39;DG&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">vfamily</span><span class="o">=</span><span class="s1">&#39;CG&#39;</span><span class="p">,</span> <span class="n">vdegree</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">coord_fs_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG_2d</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coord_fs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1</span>
            <span class="n">coord_fs_2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1_2d</span>

        <span class="c1"># ----- fields</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">V_2d</span><span class="p">)</span>
        <span class="c1"># correct treatment of the split 2d functions</span>
        <span class="n">uv_2d</span><span class="p">,</span> <span class="n">eta2d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span> <span class="o">=</span> <span class="n">uv_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span> <span class="o">=</span> <span class="n">eta2d</span>
        <span class="c1"># elevation field seen by the 3D mode, different from elev_2d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_domain_2d</span> <span class="o">=</span> <span class="n">ExtrudedFunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_2d</span><span class="p">,</span> <span class="n">mesh_3d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_cg_2d</span> <span class="o">=</span> <span class="n">ExtrudedFunction</span><span class="p">(</span><span class="n">coord_fs_2d</span><span class="p">,</span> <span class="n">mesh_3d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span> <span class="o">=</span> <span class="n">ExtrudedFunction</span><span class="p">(</span><span class="n">coord_fs_2d</span><span class="p">,</span> <span class="n">mesh_3d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="c1"># z coordinate in the strecthed mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">z_coord_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">coord_fs</span><span class="p">)</span>
        <span class="c1"># z coordinate in the reference mesh (eta=0)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">z_coord_ref_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">coord_fs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">split_residual_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">w_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">W</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">hcc_metric_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;mesh consistency&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_ale_moving_mesh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">w_mesh_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="n">coord_fs</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_salinity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">salt_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Salinity&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_temperature</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">temp_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Temperature&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_baroclinic_formulation</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_quadratic_density</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">density_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P2DGxP2</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">density_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;Density&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">baroc_head_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H_bhead</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">int_pg_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U_int_pg</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;int_pg_3d&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">coriolis_frequency</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">coriolis_frequency</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">coriolis_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">coriolis_frequency</span>
            <span class="k">else</span><span class="p">:</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">coriolis_3d</span> <span class="o">=</span> <span class="n">extend_function_to_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">coriolis_frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mesh</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wind_stress</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wind_stress</span><span class="p">,</span> <span class="n">Function</span><span class="p">):</span>
                <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wind_stress</span><span class="o">.</span><span class="n">function_space</span><span class="p">()</span><span class="o">.</span><span class="n">mesh</span><span class="p">()</span><span class="o">.</span><span class="n">geometric_dimension</span><span class="p">()</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> \
                    <span class="s1">&#39;wind stress field must be a 3D function&#39;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">wind_stress_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wind_stress</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wind_stress</span><span class="p">,</span> <span class="n">Constant</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">wind_stress_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wind_stress</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unsupported wind stress type: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">wind_stress</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1DG_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1_2d</span><span class="p">)</span>
        <span class="n">get_horizontal_elem_size_3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">max_h_diff</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_smagorinsky_viscosity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">smag_visc_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">P1</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_limiter_for_tracers</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracer_limiter</span> <span class="o">=</span> <span class="n">limiter</span><span class="o">.</span><span class="n">VertexBasedP1DGLimiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tracer_limiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_limiter_for_velocity</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">&gt;</span> <span class="mi">0</span>
                <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;dg-dg&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uv_limiter</span> <span class="o">=</span> <span class="n">limiter</span><span class="o">.</span><span class="n">VertexBasedP1DGLimiter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">U</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uv_limiter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_turbulence</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">turbulence_model_type</span> <span class="o">==</span> <span class="s1">&#39;gls&#39;</span><span class="p">:</span>
                <span class="c1"># NOTE tke and psi should be in H as tracers ??</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">tke_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">psi_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="c1"># NOTE other turb. quantities should share the same nodes ??</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eps_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">len_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eddy_visc_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eddy_diff_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="c1"># NOTE M2 and N2 depend on d(.)/dz -&gt; use CG in vertical ?</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">shear_freq_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">buoy_freq_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">turbulence_model</span> <span class="o">=</span> <span class="n">turbulence</span><span class="o">.</span><span class="n">GenericLengthScaleModel</span><span class="p">(</span>
                    <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">tke_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">psi_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;density_3d&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">len_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eps_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eddy_diff_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eddy_visc_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">buoy_freq_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">shear_freq_3d</span><span class="p">,</span>
                    <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">turbulence_model_options</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">turbulence_model_type</span> <span class="o">==</span> <span class="s1">&#39;pacanowski&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eddy_visc_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eddy_diff_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">shear_freq_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">buoy_freq_3d</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">turb_space</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">turbulence_model</span> <span class="o">=</span> <span class="n">turbulence</span><span class="o">.</span><span class="n">PacanowskiPhilanderModel</span><span class="p">(</span>
                    <span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;density_3d&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eddy_diff_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">eddy_visc_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">buoy_freq_3d</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">shear_freq_3d</span><span class="p">,</span>
                    <span class="n">options</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">turbulence_model_options</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unsupported turbulence model: </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">turbulence_model</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">turbulence_model</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># copute total viscosity/diffusivity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_h_visc</span> <span class="o">=</span> <span class="n">SumFunction</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_h_visc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">horizontal_viscosity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_h_visc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;smag_visc_3d&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_v_visc</span> <span class="o">=</span> <span class="n">SumFunction</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_v_visc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">vertical_viscosity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_v_visc</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eddy_visc_3d&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_h_diff</span> <span class="o">=</span> <span class="n">SumFunction</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_h_diff</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">horizontal_diffusivity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_v_diff</span> <span class="o">=</span> <span class="n">SumFunction</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_v_diff</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">vertical_diffusivity</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tot_v_diff</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;eddy_diff_3d&#39;</span><span class="p">))</span></div>

<div class="viewcode-block" id="FlowSolver.add_new_field"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.add_new_field">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.add_new_field&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_new_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">shortname</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">preproc_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a field to :attr:`fields`.</span>

<span class="sd">        :arg function: representation of the field as a :class:`Function`</span>
<span class="sd">        :arg label: field label used internally by Thetis, e.g. &#39;tracer_3d&#39;</span>
<span class="sd">        :arg name: human readable name for the tracer field, e.g. &#39;Tracer concentration&#39;</span>
<span class="sd">        :arg filename: file name for outputs, e.g. &#39;Tracer3d&#39;</span>
<span class="sd">        :kwarg shortname: short version of name, e.g. &#39;Tracer&#39;</span>
<span class="sd">        :kwarg unit: units for field, e.g. &#39;-&#39;</span>
<span class="sd">        :kwarg preproc_func: optional pre-processor function which will be called before exporting</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="n">Function</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">shortname</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shortname</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">preproc_func</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">callable</span><span class="p">(</span><span class="n">preproc_func</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">label</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">field_metadata</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;Field &#39;</span><span class="si">{</span><span class="n">label</span><span class="si">}</span><span class="s2">&#39; already exists.&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">label</span><span class="p">,</span> <span class="s2">&quot;Labels cannot contain spaces&quot;</span>
        <span class="k">assert</span> <span class="s1">&#39; &#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filename</span><span class="p">,</span> <span class="s2">&quot;Filenames cannot contain spaces&quot;</span>
        <span class="n">field_metadata</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;shortname&#39;</span><span class="p">:</span> <span class="n">shortname</span> <span class="ow">or</span> <span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;unit&#39;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
            <span class="s1">&#39;filename&#39;</span><span class="p">:</span> <span class="n">filename</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">function</span>
        <span class="k">if</span> <span class="n">preproc_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_field_preproc_funcs</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="n">preproc_func</span></div>

<div class="viewcode-block" id="FlowSolver.create_equations"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.create_equations">[docs]</a>    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.create_equations&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_equations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates equation instances</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s1">&#39;uv_3d&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_fields</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">log_output</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">no_exports</span><span class="p">:</span>
            <span class="n">logfile</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">create_directory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span><span class="p">),</span> <span class="s1">&#39;log&#39;</span><span class="p">)</span>
            <span class="n">filehandler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span><span class="n">logfile</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">filehandler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%(message)s</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="n">output_logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">filehandler</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">depth</span> <span class="o">=</span> <span class="n">DepthExpression</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">,</span>
                                     <span class="n">use_nonlinear_equations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_nonlinear_equations</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">equations</span> <span class="o">=</span> <span class="n">AttrDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">sw</span> <span class="o">=</span> <span class="n">shallowwater_eq</span><span class="o">.</span><span class="n">ModeSplit2DEquations</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">solution_2d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">depth</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="p">)</span>

        <span class="n">expl_bottom_friction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_bottom_friction</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_implicit_vertical_diffusion</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">momentum</span> <span class="o">=</span> <span class="n">momentum_eq</span><span class="o">.</span><span class="n">MomentumEquation</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
            <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
            <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
            <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
            <span class="n">use_nonlinear_equations</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_nonlinear_equations</span><span class="p">,</span>
            <span class="n">use_lax_friedrichs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_lax_friedrichs_velocity</span><span class="p">,</span>
            <span class="n">use_bottom_friction</span><span class="o">=</span><span class="n">expl_bottom_friction</span><span class="p">,</span>
            <span class="n">sipg_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor</span><span class="p">,</span>
            <span class="n">sipg_factor_vertical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_vertical</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_implicit_vertical_diffusion</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">vertmomentum</span> <span class="o">=</span> <span class="n">momentum_eq</span><span class="o">.</span><span class="n">MomentumEquation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
                <span class="n">use_nonlinear_equations</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">use_lax_friedrichs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_lax_friedrichs_velocity</span><span class="p">,</span>
                <span class="n">use_bottom_friction</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_bottom_friction</span><span class="p">,</span>
                <span class="n">sipg_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor</span><span class="p">,</span>
                <span class="n">sipg_factor_vertical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_vertical</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_salinity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">salt</span> <span class="o">=</span> <span class="n">tracer_eq</span><span class="o">.</span><span class="n">TracerEquation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">salt_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
                <span class="n">use_lax_friedrichs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_lax_friedrichs_tracer</span><span class="p">,</span>
                <span class="n">use_symmetric_surf_bnd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;dg-dg&#39;</span><span class="p">,</span>
                <span class="n">sipg_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_tracer</span><span class="p">,</span>
                <span class="n">sipg_factor_vertical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_vertical_tracer</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_implicit_vertical_diffusion</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">salt_vdff</span> <span class="o">=</span> <span class="n">tracer_eq</span><span class="o">.</span><span class="n">TracerEquation</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">salt_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                    <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                    <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                    <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
                    <span class="n">use_lax_friedrichs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_lax_friedrichs_tracer</span><span class="p">,</span>
                    <span class="n">sipg_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_tracer</span><span class="p">,</span>
                    <span class="n">sipg_factor_vertical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_vertical_tracer</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_temperature</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">temp</span> <span class="o">=</span> <span class="n">tracer_eq</span><span class="o">.</span><span class="n">TracerEquation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">temp_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
                <span class="n">use_lax_friedrichs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_lax_friedrichs_tracer</span><span class="p">,</span>
                <span class="n">use_symmetric_surf_bnd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;dg-dg&#39;</span><span class="p">,</span>
                <span class="n">sipg_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_tracer</span><span class="p">,</span>
                <span class="n">sipg_factor_vertical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_vertical_tracer</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_implicit_vertical_diffusion</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">temp_vdff</span> <span class="o">=</span> <span class="n">tracer_eq</span><span class="o">.</span><span class="n">TracerEquation</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">temp_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                    <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                    <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                    <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
                    <span class="n">use_lax_friedrichs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_lax_friedrichs_tracer</span><span class="p">,</span>
                    <span class="n">sipg_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_tracer</span><span class="p">,</span>
                    <span class="n">sipg_factor_vertical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_vertical_tracer</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">sw</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;shallow_water&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_salinity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">salt</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;salt&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_temperature</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">temp</span><span class="o">.</span><span class="n">bnd_functions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;temp&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_turbulence</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">turbulence_model_type</span> <span class="o">==</span> <span class="s1">&#39;gls&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_turbulence_advection</span><span class="p">:</span>
                <span class="c1"># explicit advection equations</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">tke_adv</span> <span class="o">=</span> <span class="n">tracer_eq</span><span class="o">.</span><span class="n">TracerEquation</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">tke_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                    <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                    <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                    <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
                    <span class="n">use_lax_friedrichs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_lax_friedrichs_tracer</span><span class="p">,</span>
                    <span class="n">sipg_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_turb</span><span class="p">,</span>
                    <span class="n">sipg_factor_vertical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_vertical_turb</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">psi_adv</span> <span class="o">=</span> <span class="n">tracer_eq</span><span class="o">.</span><span class="n">TracerEquation</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">psi_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                    <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                    <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                    <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
                    <span class="n">use_lax_friedrichs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_lax_friedrichs_tracer</span><span class="p">,</span>
                    <span class="n">sipg_factor</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_turb</span><span class="p">,</span>
                    <span class="n">sipg_factor_vertical</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">sipg_factor_vertical_turb</span><span class="p">)</span>
            <span class="c1"># implicit vertical diffusion eqn with production terms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">tke_diff</span> <span class="o">=</span> <span class="n">turbulence</span><span class="o">.</span><span class="n">TKEEquation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">tke_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">turbulence_model</span><span class="p">,</span>
                <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">psi_diff</span> <span class="o">=</span> <span class="n">turbulence</span><span class="o">.</span><span class="n">PsiEquation</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">psi_3d</span><span class="o">.</span><span class="n">function_space</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">turbulence_model</span><span class="p">,</span>
                <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                <span class="n">v_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">,</span>
                <span class="n">h_elem_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">)</span>

        <span class="c1"># ----- Operators</span>
        <span class="n">tot_uv_3d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">w_solver</span> <span class="o">=</span> <span class="n">VerticalVelocitySolver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">w_3d</span><span class="p">,</span>
                                               <span class="n">tot_uv_3d</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                                               <span class="bp">self</span><span class="o">.</span><span class="n">equations</span><span class="o">.</span><span class="n">momentum</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">uv_averager</span> <span class="o">=</span> <span class="n">VerticalIntegrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span><span class="p">,</span>
                                              <span class="n">bottom_to_top</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">bnd_value</span><span class="o">=</span><span class="n">Constant</span><span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)),</span>
                                              <span class="n">average</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                                              <span class="n">elevation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_cg_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_baroclinic_formulation</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_salinity</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">salt_3d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">constant_salinity</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_temperature</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">temp_3d</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">constant_temperature</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">equation_of_state_type</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
                <span class="n">eos_options</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">equation_of_state_options</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equation_of_state</span> <span class="o">=</span> <span class="n">LinearEquationOfState</span><span class="p">(</span><span class="n">eos_options</span><span class="o">.</span><span class="n">rho_ref</span><span class="p">,</span>
                                                               <span class="n">eos_options</span><span class="o">.</span><span class="n">alpha</span><span class="p">,</span>
                                                               <span class="n">eos_options</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span>
                                                               <span class="n">eos_options</span><span class="o">.</span><span class="n">th_ref</span><span class="p">,</span>
                                                               <span class="n">eos_options</span><span class="o">.</span><span class="n">s_ref</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">equation_of_state</span> <span class="o">=</span> <span class="n">JackettEquationOfState</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_quadratic_density</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_solver</span> <span class="o">=</span> <span class="n">DensitySolverWeak</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">density_3d</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">equation_of_state</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">density_solver</span> <span class="o">=</span> <span class="n">DensitySolver</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">density_3d</span><span class="p">,</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">equation_of_state</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rho_integrator</span> <span class="o">=</span> <span class="n">VerticalIntegrator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">density_3d</span><span class="p">,</span>
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">baroc_head_3d</span><span class="p">,</span>
                                                     <span class="n">bottom_to_top</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">average</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                     <span class="n">bathymetry</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                                                     <span class="n">elevation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_cg_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_pg_calculator</span> <span class="o">=</span> <span class="n">momentum_eq</span><span class="o">.</span><span class="n">InternalPressureGradientCalculator</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">view_3d</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">bnd_functions</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span>
                <span class="n">internal_pg_scalar</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">internal_pg_scalar</span><span class="p">,</span>
                <span class="n">solver_parameters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestepper_options</span><span class="o">.</span><span class="n">explicit_momentum_options</span><span class="o">.</span><span class="n">solver_parameters</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extract_surf_dav_uv</span> <span class="o">=</span> <span class="n">SubFunctionExtractor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_2d</span><span class="p">,</span>
                                                        <span class="n">boundary</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span> <span class="n">elem_facet</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
                                                        <span class="n">elem_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_uv_dav_to_uv_dav_3d</span> <span class="o">=</span> <span class="n">ExpandFunctionTo3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span><span class="p">,</span>
                                                           <span class="n">elem_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">copy_uv_to_uv_dav_3d</span> <span class="o">=</span> <span class="n">ExpandFunctionTo3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span><span class="p">,</span>
                                                       <span class="n">elem_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_updater</span> <span class="o">=</span> <span class="n">ALEMeshUpdater</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_smagorinsky_viscosity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">smagorinsky_diff_solver</span> <span class="o">=</span> <span class="n">SmagorinskyViscosity</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">smag_visc_3d</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">smagorinsky_coefficient</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="p">,</span>
                                                                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">max_h_diff</span><span class="p">,</span>
                                                                <span class="n">weak_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="FlowSolver.create_timestepper"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.create_timestepper">[docs]</a>    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.create_timestepper&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_timestepper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates time stepper instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;equations&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_equations</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dt_mode</span> <span class="o">=</span> <span class="s1">&#39;3d&#39;</span>  <span class="c1"># &#39;split&#39;|&#39;2d&#39;|&#39;3d&#39; use constant 2d/3d dt, or split</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestepper_type</span> <span class="o">==</span> <span class="s1">&#39;LeapFrog&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span> <span class="o">=</span> <span class="n">coupled_timeintegrator</span><span class="o">.</span><span class="n">CoupledLeapFrogAM3</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestepper_type</span> <span class="o">==</span> <span class="s1">&#39;SSPRK22&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span> <span class="o">=</span> <span class="n">coupled_timeintegrator</span><span class="o">.</span><span class="n">CoupledTwoStageRK</span><span class="p">(</span><span class="n">weakref</span><span class="o">.</span><span class="n">proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported time integrator type: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">timestepper_type</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bathymetry_cg_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mesh_updater</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compute_mesh_stats</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_time_step</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">set_dt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dt_2d</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>

        <span class="c1"># compute maximal diffusivity for explicit schemes</span>
        <span class="n">degree_h</span><span class="p">,</span> <span class="n">degree_v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="o">.</span><span class="n">H</span><span class="o">.</span><span class="n">ufl_element</span><span class="p">()</span><span class="o">.</span><span class="n">degree</span><span class="p">()</span>
        <span class="n">max_diff_alpha</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">60.0</span><span class="o">/</span><span class="nb">max</span><span class="p">((</span><span class="n">degree_h</span><span class="o">*</span><span class="p">(</span><span class="n">degree_h</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)),</span> <span class="mf">1.0</span><span class="p">)</span>  <span class="c1"># FIXME depends on element type and order</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">max_h_diff</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">max_diff_alpha</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">h_elem_size_3d</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">max_h_diff</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;max h diff </span><span class="si">{:}</span><span class="s1"> - </span><span class="si">{:}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">d</span><span class="o">.</span><span class="n">max</span><span class="p">()))</span></div>

<div class="viewcode-block" id="FlowSolver.create_exporters"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.create_exporters">[docs]</a>    <span class="nd">@unfrozen</span>
    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.create_exporters&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_exporters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates file exporters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;timestepper&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_timestepper</span><span class="p">()</span>

        <span class="c1"># ----- File exporters</span>
        <span class="c1"># create export_managers and store in a list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">no_exports</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">ExportManager</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">fields_to_export</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                       <span class="n">field_metadata</span><span class="p">,</span>
                                       <span class="n">export_type</span><span class="o">=</span><span class="s1">&#39;vtk&#39;</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                       <span class="n">preproc_funcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_field_preproc_funcs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;vtk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="n">hdf5_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span><span class="p">,</span> <span class="s1">&#39;hdf5&#39;</span><span class="p">)</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">ExportManager</span><span class="p">(</span><span class="n">hdf5_dir</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">fields_to_export_hdf5</span><span class="p">,</span>
                                       <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                       <span class="n">field_metadata</span><span class="p">,</span>
                                       <span class="n">export_type</span><span class="o">=</span><span class="s1">&#39;hdf5&#39;</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                       <span class="n">preproc_funcs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_field_preproc_funcs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;hdf5&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span></div>

<div class="viewcode-block" id="FlowSolver.initialize"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Creates function spaces, equations, time stepper and exporters</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">function_spaces</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_function_spaces</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;equations&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_equations</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;timestepper&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_timestepper</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;exporters&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_exporters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="FlowSolver.assign_initial_conditions"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.assign_initial_conditions">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.assign_initial_conditions&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">assign_initial_conditions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">elev</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">uv_2d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">uv_3d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tke</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assigns initial conditions</span>

<span class="sd">        :kwarg elev: Initial condition for water elevation</span>
<span class="sd">        :type elev: scalar 2D :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg salt: Initial condition for salinity field</span>
<span class="sd">        :type salt: scalar 3D :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg temp: Initial condition for temperature field</span>
<span class="sd">        :type temp: scalar 3D :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg uv_2d: Initial condition for depth averaged velocity</span>
<span class="sd">        :type uv_2d: vector valued 2D :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg uv_3d: Initial condition for horizontal velocity</span>
<span class="sd">        :type uv_3d: vector valued 3D :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg tke: Initial condition for turbulent kinetic energy field</span>
<span class="sd">        :type tke: scalar 3D :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        :kwarg psi: Initial condition for turbulence generic length scale field</span>
<span class="sd">        :type psi: scalar 3D :class:`Function`, :class:`Constant`, or an expression</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">elev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">elev</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">uv_2d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">uv_2d</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_2d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">uv_2d</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">uv_3d</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ExpandFunctionTo3d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span><span class="p">,</span>
                                   <span class="n">elem_height</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">v_elem_size_3d</span><span class="p">)</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">uv_3d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">uv_3d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">salt</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_salinity</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">salt_3d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">salt</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">temp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_temperature</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">temp_3d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_turbulence</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">turbulence_model_type</span> <span class="o">==</span> <span class="s1">&#39;gls&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">tke</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">tke_3d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">tke</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">psi</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">psi_3d</span><span class="o">.</span><span class="n">project</span><span class="p">(</span><span class="n">psi</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">turbulence_model</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_ale_moving_mesh</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">_update_3d_elevation</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">_update_moving_mesh</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="c1"># update all diagnostic variables</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">_update_all_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span><span class="p">,</span>
                                                  <span class="n">do_2d_coupling</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                  <span class="n">do_vert_diffusion</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                  <span class="n">do_ale_update</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">do_stab_params</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                  <span class="n">do_turbulence</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_turbulence</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">turbulence_model</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span></div>

<div class="viewcode-block" id="FlowSolver.add_callback"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.add_callback">[docs]</a>    <span class="k">def</span> <span class="nf">add_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds callback to solver object</span>

<span class="sd">        :arg callback: :class:`.DiagnosticCallback` instance</span>
<span class="sd">        :kwarg str eval_interval: Determines when callback will be evaluated,</span>
<span class="sd">            either &#39;export&#39; or &#39;timestep&#39; for evaluating after each export or</span>
<span class="sd">            time step.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">eval_interval</span><span class="p">)</span></div>

<div class="viewcode-block" id="FlowSolver.export"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.export">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.export&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">export</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Export all fields to disk</span>

<span class="sd">        Also evaluates all callbacks set to &#39;export&#39; interval.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i_export</span><span class="p">)</span>
        <span class="c1"># set uv to total uv instead of deviation from depth average</span>
        <span class="c1"># TODO find a cleaner way of doing this ...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">e</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
        <span class="c1"># restore uv_3d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span> <span class="o">-=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_dav_3d</span></div>

<div class="viewcode-block" id="FlowSolver.load_state"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.load_state">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.load_state&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">load_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i_export</span><span class="p">,</span> <span class="n">outputdir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">t</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Loads simulation state from hdf5 outputs.</span>

<span class="sd">        This replaces :meth:`.assign_initial_conditions` in model initilization.</span>

<span class="sd">        This assumes that model setup is kept the same (e.g. time step) and</span>
<span class="sd">        all pronostic state variables are exported in hdf5 format.  The required</span>
<span class="sd">        state variables are: elev_2d, uv_2d, uv_3d, salt_3d, temp_3d, tke_3d,</span>
<span class="sd">        psi_3d</span>

<span class="sd">        Currently hdf5 field import only works for the same number of MPI</span>
<span class="sd">        processes.</span>

<span class="sd">        :arg int i_export: export index to load</span>
<span class="sd">        :kwarg string outputdir: (optional) directory where files are read from.</span>
<span class="sd">            By default ``options.output_directory``.</span>
<span class="sd">        :kwarg float t: simulation time. Overrides the time stamp stored in the</span>
<span class="sd">            hdf5 files.</span>
<span class="sd">        :kwarg int iteration: Overrides the iteration count in the hdf5 files.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">outputdir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">outputdir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_continued</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># create new ExportManager with desired outputdir</span>
        <span class="n">state_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;uv_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;elev_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;uv_3d&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;salt_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;tke_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;psi_3d&#39;</span><span class="p">]</span>
        <span class="n">hdf5_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outputdir</span><span class="p">,</span> <span class="s1">&#39;hdf5&#39;</span><span class="p">)</span>
        <span class="n">e</span> <span class="o">=</span> <span class="n">exporter</span><span class="o">.</span><span class="n">ExportManager</span><span class="p">(</span><span class="n">hdf5_dir</span><span class="p">,</span>
                                   <span class="n">state_fields</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">,</span>
                                   <span class="n">field_metadata</span><span class="p">,</span>
                                   <span class="n">export_type</span><span class="o">=</span><span class="s1">&#39;hdf5&#39;</span><span class="p">,</span>
                                   <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;uv_2d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_export</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;elev_2d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_export</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span><span class="p">)</span>
        <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;uv_3d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_export</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="p">)</span>
        <span class="c1"># NOTE remove mean from uv_3d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">_remove_depth_average_from_uv_3d</span><span class="p">()</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">tke</span> <span class="o">=</span> <span class="n">psi</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_salinity</span><span class="p">:</span>
            <span class="n">salt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">salt_3d</span>
            <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;salt_3d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_export</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_temperature</span><span class="p">:</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">temp_3d</span>
            <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;temp_3d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_export</span><span class="p">,</span> <span class="n">temp</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_turbulence</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;tke_3d&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">tke</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">tke_3d</span>
                <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;tke_3d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_export</span><span class="p">,</span> <span class="n">tke</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;psi_3d&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">:</span>
                <span class="n">psi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">psi_3d</span>
                <span class="n">e</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;psi_3d&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">i_export</span><span class="p">,</span> <span class="n">psi</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assign_initial_conditions</span><span class="p">(</span><span class="n">elev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span><span class="p">,</span>
                                       <span class="n">uv_2d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_2d</span><span class="p">,</span>
                                       <span class="n">uv_3d</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="p">,</span>
                                       <span class="n">salt</span><span class="o">=</span><span class="n">salt</span><span class="p">,</span> <span class="n">temp</span><span class="o">=</span><span class="n">temp</span><span class="p">,</span>
                                       <span class="n">tke</span><span class="o">=</span><span class="n">tke</span><span class="p">,</span> <span class="n">psi</span><span class="o">=</span><span class="n">psi</span><span class="p">,</span>
                                       <span class="p">)</span>

        <span class="c1"># time stepper bookkeeping for export time step</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span> <span class="o">=</span> <span class="n">i_export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">iteration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">t</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">iteration</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">=</span> <span class="n">t</span>

        <span class="c1"># for next export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">export_initial_state</span> <span class="o">=</span> <span class="n">outputdir</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">output_directory</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_initial_state</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">offset</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>
        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">e</span><span class="o">.</span><span class="n">set_next_export_ix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">i_export</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span></div>

<div class="viewcode-block" id="FlowSolver.print_state"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.print_state">[docs]</a>    <span class="k">def</span> <span class="nf">print_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cputime</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print a summary of the model state on stdout</span>

<span class="sd">        :arg float cputime: Measured CPU time</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">norm_h</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">elev_2d</span><span class="p">)</span>
        <span class="n">norm_u</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">uv_3d</span><span class="p">)</span>

        <span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">{iexp:5d}</span><span class="s1"> </span><span class="si">{i:5d}</span><span class="s1"> T=</span><span class="si">{t:10.2f}</span><span class="s1"> &#39;</span>
                <span class="s1">&#39;eta norm: </span><span class="si">{e:10.4f}</span><span class="s1"> u norm: </span><span class="si">{u:10.4f}</span><span class="s1"> </span><span class="si">{cpu:5.2f}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iexp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">i_export</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">,</span>
                                 <span class="n">t</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span><span class="p">,</span> <span class="n">e</span><span class="o">=</span><span class="n">norm_h</span><span class="p">,</span>
                                 <span class="n">u</span><span class="o">=</span><span class="n">norm_u</span><span class="p">,</span> <span class="n">cpu</span><span class="o">=</span><span class="n">cputime</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_print_field</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">field</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Prints min/max values of a field for debugging.</span>

<span class="sd">        :arg field: a :class:`Function` or a field string, e.g. &#39;salt_3d&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">_field</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">field</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_field</span> <span class="o">=</span> <span class="n">field</span>
        <span class="n">minval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_field</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
        <span class="n">minval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">minval</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MIN</span><span class="p">)</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">_field</span><span class="o">.</span><span class="n">dat</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">allreduce</span><span class="p">(</span><span class="n">maxval</span><span class="p">,</span> <span class="n">op</span><span class="o">=</span><span class="n">MPI</span><span class="o">.</span><span class="n">MAX</span><span class="p">)</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;    </span><span class="si">{:}</span><span class="s1">: </span><span class="si">{:.4f}</span><span class="s1"> </span><span class="si">{:.4f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_field</span><span class="o">.</span><span class="n">name</span><span class="p">(),</span> <span class="n">minval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">))</span>

<div class="viewcode-block" id="FlowSolver.print_state_debug"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.print_state_debug">[docs]</a>    <span class="k">def</span> <span class="nf">print_state_debug</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Print min/max values of prognostic/diagnostic fields for debugging.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">field_list</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;elev_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;uv_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;elev_domain_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;elev_cg_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;uv_3d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;w_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;uv_dav_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;w_mesh_3d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;salt_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;temp_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;density_3d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;baroc_head_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;int_pg_3d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;psi_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;eps_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;eddy_visc_3d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;shear_freq_3d&#39;</span><span class="p">,</span> <span class="s1">&#39;buoy_freq_3d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;coriolis_2d&#39;</span><span class="p">,</span> <span class="s1">&#39;coriolis_3d&#39;</span><span class="p">,</span>
            <span class="s1">&#39;wind_stress_3d&#39;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">print_output</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:06}</span><span class="s1"> T=</span><span class="si">{:10.2f}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">fieldname</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fieldname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fields</span>
                    <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">],</span> <span class="n">Function</span><span class="p">)):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_print_field</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="p">[</span><span class="n">fieldname</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comm</span><span class="o">.</span><span class="n">barrier</span><span class="p">()</span></div>

<div class="viewcode-block" id="FlowSolver.iterate"><a class="viewcode-back" href="../../thetis.html#thetis.solver.FlowSolver.iterate">[docs]</a>    <span class="nd">@PETSc</span><span class="o">.</span><span class="n">Log</span><span class="o">.</span><span class="n">EventDecorator</span><span class="p">(</span><span class="s2">&quot;thetis.FlowSolver.iterate&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">iterate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">update_forcings</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_forcings3d</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">export_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs the simulation</span>

<span class="sd">        Iterates over the time loop until time ``options.simulation_end_time`` is reached.</span>
<span class="sd">        Exports fields to disk on ``options.simulation_export_time`` intervals.</span>

<span class="sd">        :kwarg update_forcings: User-defined function that takes simulation</span>
<span class="sd">            time as an argument and updates time-dependent boundary conditions</span>
<span class="sd">            of the 2D system (if any).</span>
<span class="sd">        :kwarg update_forcings_3d: User-defined function that takes simulation</span>
<span class="sd">            time as an argument and updates time-dependent boundary conditions</span>
<span class="sd">            of the 3D equations (if any).</span>
<span class="sd">        :kwarg export_func: User-defined function (with no arguments) that will</span>
<span class="sd">            be called on every export.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialized</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_salinity_conservation</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_salinity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_salinity_overshoot</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_salinity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_temperature_conservation</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_temperature_overshoot</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">solve_temperature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_volume_conservation_3d</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_ale_moving_mesh</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_limiter_for_tracers</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_limiter_for_velocity</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">polynomial_degree</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">use_limiter_for_velocity</span> <span class="o">&amp;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">element_family</span> <span class="o">==</span> <span class="s1">&#39;dg-dg&#39;</span>

        <span class="n">t_epsilon</span> <span class="o">=</span> <span class="mf">1.0e-5</span>
        <span class="n">cputimestamp</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="n">dump_hdf5</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">export_diagnostics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">no_exports</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_volume_conservation_2d</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">VolumeConservation2DCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                      <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                      <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_volume_conservation_3d</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">VolumeConservation3DCallback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                                      <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                      <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_salinity_conservation</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">TracerMassConservationCallback</span><span class="p">(</span><span class="s1">&#39;salt_3d&#39;</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="p">,</span>
                                                        <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                        <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_salinity_overshoot</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">TracerOvershootCallBack</span><span class="p">(</span><span class="s1">&#39;salt_3d&#39;</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="p">,</span>
                                                 <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                 <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_temperature_conservation</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">TracerMassConservationCallback</span><span class="p">(</span><span class="s1">&#39;temp_3d&#39;</span><span class="p">,</span>
                                                        <span class="bp">self</span><span class="p">,</span>
                                                        <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                        <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">check_temperature_overshoot</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">callback</span><span class="o">.</span><span class="n">TracerOvershootCallBack</span><span class="p">(</span><span class="s1">&#39;temp_3d&#39;</span><span class="p">,</span>
                                                 <span class="bp">self</span><span class="p">,</span>
                                                 <span class="n">export_to_hdf5</span><span class="o">=</span><span class="n">dump_hdf5</span><span class="p">,</span>
                                                 <span class="n">append_to_log</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">eval_interval</span><span class="o">=</span><span class="s1">&#39;export&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_simulation_continued</span><span class="p">:</span>
            <span class="c1"># set all callbacks to append mode</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">m</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">m</span><span class="p">][</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">set_write_mode</span><span class="p">(</span><span class="s1">&#39;append&#39;</span><span class="p">)</span>

        <span class="c1"># initial export</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">print_state</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">export_initial_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">export_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">export_func</span><span class="p">()</span>
            <span class="k">if</span> <span class="s1">&#39;vtk&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">exporters</span><span class="p">[</span><span class="s1">&#39;vtk&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">export_bathymetry</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fields</span><span class="o">.</span><span class="n">bathymetry_2d</span><span class="p">)</span>

        <span class="n">initial_simulation_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span>
        <span class="n">internal_iteration</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_end_time</span> <span class="o">-</span> <span class="n">t_epsilon</span><span class="p">:</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">timestepper</span><span class="o">.</span><span class="n">advance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span><span class="p">,</span>
                                     <span class="n">update_forcings</span><span class="p">,</span> <span class="n">update_forcings3d</span><span class="p">)</span>

            <span class="c1"># Move to next time step</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">iteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">internal_iteration</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">=</span> <span class="n">initial_simulation_time</span> <span class="o">+</span> <span class="n">internal_iteration</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dt</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;timestep&#39;</span><span class="p">)</span>

            <span class="c1"># Write the solution to file</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulation_time</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">-</span> <span class="n">t_epsilon</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">i_export</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">next_export_t</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">simulation_export_time</span>

                <span class="n">cputime</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">cputimestamp</span>
                <span class="n">cputimestamp</span> <span class="o">=</span> <span class="n">time_mod</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">print_state</span><span class="p">(</span><span class="n">cputime</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">export</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">export_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">export_func</span><span class="p">()</span></div></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
    </div>
      <div class="clearer"></div>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2016-2022, Tuomas Krn et al..
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 4.3.2.
    </div>
  </body>
</html>